<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en'>
  <head>
    <title>Bindings</title>
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <meta content='A dead easy to use RabbitMQ Ruby client' name='description' />
    <meta content='The Ruby RabbitMQ Client Maintainers Team' name='author' />
    <link href='/assets/stylesheets/bootstrap.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/bootstrap-responsive.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/sass/styles.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='http://fonts.googleapis.com/css?family=Signika+Negative:300,400,600' rel='stylesheet' type='text/css' />
    <script src='/assets/javascripts/jquery-1.7.min.js' type='text/javascript'></script>
    <script src='/assets/javascripts/toc.js'></script>
    <script src='/assets/javascripts/bootstrap-collapse.js'></script>
    <meta content='text/html;charset=utf-8' http-equiv='Content-Type' />
    <script type="text/javascript">
      if(!(window.location.hostname === "localhost")) {
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-27153041-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
      }
    </script>
  </head>

  <body>
    <div class='navbar navbar-inverse navbar-fixed-top'>
      <div class='navbar-inner'>
        <div class='container-fluid'>
          <a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </a>
          <a class='brand' href='/'>Ruby amqp gem</a>
          <div class='nav-collapse'>
            <ul class='nav'>
            <li>
              <a href="/">Home</a>
            </li>
            <li>
              <a href="/articles/guides.html">All guides</a>
            </li>
            <li>
              <a href='/articles/community.html'>Community</a>
            </li>
            <li>
              <a href='http://rubybunny.info'>Bunny, an alternative client</a>
            </li>
            <li>
              <a href='https://github.com/ruby-amqp/amqp'>Code on Github</a>
            </li>
            <li>
              <a href='http://github.com/ruby-amqp'>Other RabbitMQ Ruby clients</a>
            </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class='container-fluid'>
      <div class='row-fluid'>
        <div class='span3'>
          <div class='well sidebar-nav'></div>
        </div>
        <div class='span9'>
          <h1>Bindings</h1>
          <h2 id="about-this-guide">About this guide</h2>

<p>This guide covers bindings in AMQP 0.9.1, what they are, what role they
play and how to accomplish typical operations using the Ruby amqp gem.</p>

<p>This work is licensed under a
<a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative
Commons Attribution 3.0 Unported License</a> (including images and
stylesheets). The source is available <a href="https://github.com/ruby-amqp/rubyamqp.info">on
Github</a>.</p>

<h2 id="covered-versions">Covered versions</h2>

<p>This guide covers Ruby amqp gem 1.7.0 and later.</p>

<h2 id="bindings-in-amqp-0-9-1">Bindings in AMQP 0.9.1</h2>

<p>Learn more about how bindings fit into the AMQP Model in the <a href="http://www.rabbitmq.com/tutorials/amqp-concepts.html">AMQP 0.9.1
Model Explained</a> documentation
guide.</p>

<h2 id="what-are-amqp-0-9-1-bindings">What Are AMQP 0.9.1 Bindings</h2>

<p>Bindings are rules that exchanges use (among other things) to route
messages to queues. To instruct an exchange E to route messages to a
queue Q, Q has to <em>be bound</em> to E. Bindings may have an optional
<em>routing key</em> attribute used by some exchange types. The purpose of the
routing key is to selectively match only specific (matching) messages
published to an exchange to the bound queue. In other words, the routing
key acts like a filter.</p>

<p>To draw an analogy:</p>

<ul>
<li>Queue is like your destination in New York city</li>
<li>Exchange is like JFK airport</li>
<li>Bindings are routes from JFK to your destination. There may be no
way, or more than one way, to reach it</li>
</ul>

<p>Some exchange types use routing keys while some others do not (routing
messages unconditionally or based on message metadata). If an AMQP
message cannot be routed to any queue (for example, because there are no
bindings for the exchange it was published to), it is either dropped or
returned to the publisher, depending on the message attributes that the
publisher has set.</p>

<p>If an application wants to connect a queue to an exchange, it needs to
<em>bind</em> them. The opposite operation is called <em>unbinding</em>.</p>

<h2 id="binding-queues-to-exchanges">Binding queues to exchanges</h2>

<p>In order to receive messages, a queue needs to be bound to at least one
exchange. Most of the time binding is explcit (done by applications). To
bind a queue to an exchange, use { yard_link AMQP::Queue#bind } where
the argument passed can be either an { yard_link AMQP::Exchange }
instance or a string.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">bind_ok</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"Just bound </span><span class="si">#{</span><span class="n">queue</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">exchange</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="c1"># Binding a queue to an exchange</span>
<span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="s2">"amqp://guest:guest@dev.rabbitmq.com"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="p">,</span> <span class="n">open_ok</span><span class="o">|</span>
  <span class="n">channel</span>  <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"amq.fanout"</span><span class="p">)</span>

  <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:exclusive</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">queue</span><span class="p">,</span> <span class="n">declare_ok</span><span class="o">|</span>
    <span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">bind_ok</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">"Just bound </span><span class="si">#{</span><span class="n">queue</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">exchange</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>

    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span>
      <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">{</span> <span class="nb">exit</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The same example using a string without a callback:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="s2">"amq.fanout"</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="c1"># Binding a queue to an exchange</span>
<span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="s2">"amqp://guest:guest@dev.rabbitmq.com"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="p">,</span> <span class="n">open_ok</span><span class="o">|</span>
  <span class="n">channel</span> <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">exchange_name</span> <span class="o">=</span> <span class="s2">"amq.fanout"</span>

  <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:exclusive</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">queue</span><span class="p">,</span> <span class="n">declare_ok</span><span class="o">|</span>
    <span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange_name</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Bound </span><span class="si">#{</span><span class="n">queue</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">exchange_name</span><span class="si">}</span><span class="s2">"</span>

    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span>
      <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">{</span> <span class="nb">exit</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h2 id="unbinding-queues-from-exchanges">Unbinding queues from exchanges</h2>

<p>To unbind a queue from an exchange use
<code>AMQP::Queue\#unbind</code>:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">queue</span><span class="p">.</span><span class="nf">unbind</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="s2">"amqp://guest:guest@dev.rabbitmq.com"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="p">,</span> <span class="n">open_ok</span><span class="o">|</span>
  <span class="n">channel</span> <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">channel</span><span class="p">.</span><span class="nf">on_error</span> <span class="k">do</span> <span class="o">|</span><span class="n">ch</span><span class="p">,</span> <span class="n">channel_close</span><span class="o">|</span>
    <span class="k">raise</span> <span class="s2">"Channel-level exception: </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_text</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="n">exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"amq.fanout"</span><span class="p">)</span>

  <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:exclusive</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">queue</span><span class="p">,</span> <span class="n">declare_ok</span><span class="o">|</span>
    <span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>

    <span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">queue</span><span class="p">.</span><span class="nf">unbind</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span>
        <span class="nb">puts</span> <span class="s2">"Unbound. Shutting down..."</span>

        <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span> <span class="c1"># EventMachine.add_timer</span>
  <span class="k">end</span> <span class="c1"># channel.queue</span>
<span class="k">end</span>
</code></pre></div>
<p><span class="note">Trying to unbind a queue from an exchange that the
queue was never bound to will result in a channel-level
exception.</span></p>

<h2 id="bindings-routing-and-returned-messages">Bindings, Routing and Returned Messages</h2>

<h3 id="how-amqp-0-9-1-brokers-route-messages">How AMQP 0.9.1 Brokers Route Messages</h3>

<p>After an AMQP message reaches an AMQP broker and before it reaches a
consumer, several things happen:</p>

<ul>
<li>AMQP broker needs to find one or more queues that the message needs
to be routed to, depending on type of exchange

<ul>
<li>AMQP broker puts a copy of the message into each of those queues or
decides to return the message to the publisher</li>
<li>AMQP broker pushes message to consumers on those queues or waits for
applications to fetch them on demand</li>
</ul></li>
</ul>

<p>A more in-depth description is this:</p>

<ul>
<li>AMQP broker needs to consult bindings list for the exchange the
message was published to in order to find one or more queues that the
message needs to be routed to (step 1)</li>
<li>If there are no suitable queues found during step 1 and the message
was published as mandatory, it is returned to the publisher (step 1b)</li>
<li>If there are suitable queues, a <em>copy</em> of the message is placed into
each one (step 2)</li>
<li>If the message was published as mandatory, but there are no active
consumers for it, it is returned to the publisher (step 2b)</li>
<li>If there are active consumers on those queues and the basic.qos
setting permits, message is pushed to those consumers (step 3)</li>
</ul>

<p>The important thing to take away from this is that messages may or may
not be routed and it is important for applications to handle unroutable
messages.</p>

<h3 id="handling-of-unroutable-messages">Handling of Unroutable Messages</h3>

<p>Unroutable messages are either dropped or returned to producers.
Vendor-specific extensions can provide additional ways of handling
unroutable messages: for example, RabbitMQ’s <a href="http://www.rabbitmq.com/ae.html">Alternate Exchanges
extension</a> makes it possible to route
unroutable messages to another exchange. amqp gem support for it is
documented in the <a href="/articles/broker_specific_extensions/">Vendor-specific Extensions
guide</a>.</p>

<p>The amqp gem provides a way to handle returned messages with the
<code>AMQP::Exchange#on_return</code> method:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">exchange</span><span class="p">.</span><span class="nf">on_return</span> <span class="k">do</span> <span class="o">|</span><span class="n">basic_return</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2"> was returned! reply_code = </span><span class="si">#{</span><span class="n">basic_return</span><span class="p">.</span><span class="nf">reply_code</span><span class="si">}</span><span class="s2">, reply_text = </span><span class="si">#{</span><span class="n">basic_return</span><span class="p">.</span><span class="nf">reply_text</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div>
<p><a href="/articles/working_with_exchanges/">Working With Exchanges</a>
documentation guide provides more information on the subject, including
full code examples.</p>

        </div>
      </div>
    <footer class='footer'>
      <div class='container'>
        <p>This website was developed by the
          &nbsp;<a href='http://github.com/ruby-amqp'>Ruby RabbitMQ Client Maintainers Team</a>.</p>
        <p>Follow us on Twitter:
          &nbsp;<a href='http://twitter.com/rubyamqp'>rubyamqp</a>,&nbsp;<a href='http://twitter.com/michaelklishin'>Michael Klishin</a>,&nbsp;<a href='http://twitter.com/celldee'>Chris Duncan</a></p>
      </div>
    </footer>
  </body>
</html>
