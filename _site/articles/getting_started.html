<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en'>
  <head>
    <title>Getting Started with RabbitMQ and Ruby Using amqp gem</title>
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <meta content='A dead easy to use RabbitMQ Ruby client' name='description' />
    <meta content='The Ruby RabbitMQ Client Maintainers Team' name='author' />
    <link href='/assets/stylesheets/bootstrap.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/bootstrap-responsive.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/sass/styles.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='http://fonts.googleapis.com/css?family=Signika+Negative:300,400,600' rel='stylesheet' type='text/css' />
    <script src='/assets/javascripts/jquery-1.7.min.js' type='text/javascript'></script>
    <script src='/assets/javascripts/toc.js'></script>
    <script src='/assets/javascripts/bootstrap-collapse.js'></script>
    <meta content='text/html;charset=utf-8' http-equiv='Content-Type' />
    <script type="text/javascript">
      if(!(window.location.hostname === "localhost")) {
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-27153041-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
      }
    </script>
  </head>

  <body>
    <div class='navbar navbar-inverse navbar-fixed-top'>
      <div class='navbar-inner'>
        <div class='container-fluid'>
          <a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </a>
          <a class='brand' href='/'>Ruby amqp gem</a>
          <div class='nav-collapse'>
            <ul class='nav'>
            <li>
              <a href="/">Home</a>
            </li>
            <li>
              <a href="/articles/guides.html">All guides</a>
            </li>
            <li>
              <a href='/articles/community.html'>Community</a>
            </li>
            <li>
              <a href='http://rubybunny.info'>Bunny, an alternative client</a>
            </li>
            <li>
              <a href='https://github.com/ruby-amqp/amqp'>Code on Github</a>
            </li>
            <li>
              <a href='http://github.com/ruby-amqp'>Other RabbitMQ Ruby clients</a>
            </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class='container-fluid'>
      <div class='row-fluid'>
        <div class='span3'>
          <div class='well sidebar-nav'></div>
        </div>
        <div class='span9'>
          <h1>Getting Started with RabbitMQ and Ruby Using amqp gem</h1>
          <h2 id="about-this-guide">About this guide</h2>

<p>This guide is a quick tutorial that helps you to get started with
RabbitMQ and the <a href="http://github.com/ruby-amqp/amqp">Ruby amqp gem</a>.
It should take about 20 minutes to read and study the provided code
examples. This guide covers:</p>

<ul>
<li>Installing RabbitMQ, a mature popular server implementation of the AMQP protocol.</li>
<li>Installing the amqp gem via <a href="http://rubygems.org">Rubygems</a> and <a href="http://gembundler.com">Bundler</a>.</li>
<li>Running a &quot;Hello, world&quot; messaging example that is a simple demonstration of 1:1 communication.</li>
<li>Creating a &quot;Twitter-like&quot; publish/subscribe example with one publisher and four subscribers that demonstrates 1:n communication.</li>
<li>Creating a topic routing example with two publishers and eight subscribers showcasing n:m communication when subscribers only receive messages that they are interested in.</li>
<li>Learning how the amqp gem can be integrated with Ruby objects in a way that makes unit testing easy.</li>
</ul>

<p>This work is licensed under a <a rel="license"
href="http://creativecommons.org/licenses/by/3.0/">Creative Commons
Attribution 3.0 Unported License</a> (including images and
stylesheets).  The source is available <a href="https://github.com/ruby-amqp/rubyamqp.info">on
GitHub</a>.</p>

<h2 id="which-versions-of-the-amqp-gem-does-this-guide-cover">Which versions of the amqp gem does this guide cover?</h2>

<p>This guide covers Ruby amqp gem 1.7.0 and later versions.</p>

<h2 id="installing-rabbitmq">Installing RabbitMQ</h2>

<p>The <a href="http://rabbitmq.com">RabbitMQ site</a> has a good <a href="http://www.rabbitmq.com/install.html">installation guide</a> that addresses many operating systems.
On Mac OS X, the fastest way to install RabbitMQ is with <a href="http://mxcl.github.com/homebrew">Homebrew</a>:</p>
<div class="highlight"><pre><code class="language-" data-lang="">brew install rabbitmq
</code></pre></div>
<p>then run it:</p>
<div class="highlight"><pre><code class="language-" data-lang="">rabbitmq-server
</code></pre></div>
<p>On Debian and Ubuntu, you can either <a href="http://www.rabbitmq.com/server.html">download the RabbitMQ .deb
package</a> and install it with
<a href="http://www.debian.org/doc/FAQ/ch-pkgtools.en.html">dpkg</a> or make use
of the <a href="http://www.rabbitmq.com/debian.html#apt">apt repository</a> that
the RabbitMQ team provides.</p>

<p>For RPM-based distributions like RedHat or CentOS, the RabbitMQ team
provides an <a href="http://www.rabbitmq.com/install.html#rpm">RPM package</a>.</p>

<div class="alert alert-error"><strong>Note:</strong> The RabbitMQ
package that ships with some popular Ubuntu versions (for example,
10.04 and 10.10) is outdated and *will not work with amqp gem 0.8.0
and later versions* (you will need at least RabbitMQ v2.0 for use with
this guide).</div>

<h2 id="installing-the-ruby-amqp-gem">Installing the Ruby amqp gem</h2>

<h3 id="make-sure-that-you-have-ruby-and-rubygems-installed">Make sure that you have Ruby and <a href="http://docs.rubygems.org/read/chapter/3">Rubygems</a> installed</h3>

<p>This guide assumes that you have installed one of the following
supported Ruby implementations:</p>

<ul>
<li>CRuby v2.4</li>
<li>CRuby v2.3</li>
<li>CRuby v2.2</li>
<li>CRuby v2.1</li>
<li>CRuby v2.0</li>
</ul>

<h3 id="you-can-use-rubygems-to-install-the-amqp-gem">You can use Rubygems to install the amqp gem</h3>

<h4 id="on-microsoft-windows-7">On Microsoft Windows 7:</h4>
<div class="highlight"><pre><code class="language-" data-lang="">gem install eventmachine
gem install amqp
</code></pre></div>
<h4 id="on-other-oses-or-jruby">On other OSes or JRuby:</h4>
<div class="highlight"><pre><code class="language-" data-lang="">gem install amqp
</code></pre></div>
<h3 id="you-can-also-use-bundler-to-install-the-gem">You can also use Bundler to install the gem</h3>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">source</span> <span class="s2">"https://rubygems.org"</span>
<span class="n">gem</span> <span class="s2">"amqp"</span><span class="p">,</span> <span class="s2">"~&gt; 1.7.0"</span>
</code></pre></div>
<h3 id="verifying-your-installation">Verifying your installation</h3>

<p>Verify your installation with a quick irb session:</p>
<div class="highlight"><pre><code class="language-" data-lang="">irb -rubygems
:001 &gt; require "amqp"
=&gt; true
:002 &gt; AMQP::VERSION
=&gt; "1.7.0"
</code></pre></div>
<h2 id="hello-world-example">&quot;Hello, world&quot; example</h2>

<p>Let us begin with the classic &quot;Hello, world&quot; example. First, here is the code:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="n">connection</span> <span class="o">=</span> <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">'127.0.0.1'</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Connected to AMQP broker. Running </span><span class="si">#{</span><span class="no">AMQP</span><span class="o">::</span><span class="no">VERSION</span><span class="si">}</span><span class="s2"> version of the gem..."</span>

  <span class="n">channel</span>  <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">queue</span>    <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"amqpgem.examples.helloworld"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">direct</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>

  <span class="n">queue</span><span class="p">.</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">payload</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"Received a message: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">. Disconnecting..."</span>
    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">exchange</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"Hello, world!"</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="n">queue</span><span class="p">.</span><span class="nf">name</span>
<span class="k">end</span>
</code></pre></div>
<p>This example demonstrates a very common communication scenario: <em>application A</em> wants to publish a message that will end up in a queue that <em>application B</em> listens on. In this case, the queue name is &quot;amqpgem.examples.hello&quot;. Let us go through the code step by step:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>
</code></pre></div>
<p>is the simplest way to load the amqp gem if you have installed it with RubyGems, but remember that you can omit the rubygems line if your environment does not need it. The following piece of code</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div>
<p>runs what is called the <a href="http://rubyeventmachine.com">EventMachine</a>
reactor. We will not go into what the term &#39;reactor&#39; means here, but
suffice it to say that the amqp gem is asynchronous and is based on an
asynchronous network I/O library called <em>EventMachine</em>.</p>

<p>The next line</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">connection</span> <span class="o">=</span> <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">'127.0.0.1'</span><span class="p">)</span>
</code></pre></div>
<p>connects to the server running on localhost, with the default port (5672), username (guest), password (guest) and virtual host (&#39;/&#39;).</p>

<p>The next line</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">channel</span>  <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
</code></pre></div>
<p>opens a new <em>channel</em>. AMQP is a multi-channeled protocol that uses channels to multiplex a TCP connection.</p>

<p>Channels are opened on a connection, therefore the <code>AMQP::Channel</code> constructor takes a connection object as a parameter.</p>

<p>This line</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">queue</span>    <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"amqpgem.examples.helloworld"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</code></pre></div>
<p>declares a <em>queue</em> on the channel that we have just opened. Consumer applications get messages from queues. We declared this queue with the &quot;auto-delete&quot; parameter. Basically, this means that the queue will be deleted when there are no more processes consuming messages from it.</p>

<p>The next line</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">direct</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
</code></pre></div>
<p>instantiates an <em>exchange</em>. Exchanges receive messages that are sent
by producers. Exchanges route messages to queues according to rules
called <em>bindings</em>. In this particular example, there are no explicitly
defined bindings. The exchange that we defined is known as the
<em>default exchange</em> and it has implied bindings to all queues. Before
we get into that, let us see how we define a handler for incoming
messages</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">queue</span><span class="p">.</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">payload</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"Received a message: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">. Disconnecting..."</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p><code>AMQP::Queue#subscribe</code> takes a block that will be called every time a message arrives. <code>AMQP::Session#close</code> closes the AMQP connection and runs a callback that stops the EventMachine reactor.</p>

<p>Finally, we publish our message</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">exchange</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"Hello, world!"</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="n">queue</span><span class="p">.</span><span class="nf">name</span>
</code></pre></div>
<p>Routing key is one of the <em>message attributes</em>. The default exchange
will route the message to a queue that has the same name as the
message&#39;s routing key. This is how our message ends up in the
&quot;amqpgem.examples.helloworld&quot; queue.</p>

<p>This first example can be modified to use the method chaining technique:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">'127.0.0.1'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"Connected to AMQP broker. Running </span><span class="si">#{</span><span class="no">AMQP</span><span class="o">::</span><span class="no">VERSION</span><span class="si">}</span><span class="s2"> version of the gem..."</span>

    <span class="n">channel</span>  <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"amqpgem.examples.helloworld"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">payload</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">"Received a message: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">. Disconnecting..."</span>

      <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">channel</span><span class="p">.</span><span class="nf">direct</span><span class="p">(</span><span class="s2">""</span><span class="p">).</span><span class="nf">publish</span> <span class="s2">"Hello, world!"</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"amqpgem.examples.helloworld"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>This diagram demonstrates the &quot;Hello, world&quot; example data flow:</p>

<p>!<a href="https://github.com/ruby-amqp/amqp/raw/master/docs/diagrams/001_hello_world_example_routing.png">https://github.com/ruby-amqp/amqp/raw/master/docs/diagrams/001_hello_world_example_routing.png</a>!</p>

<p>For the sake of simplicity, both the message producer (App I) and the
consumer (App II) are running in the same Ruby process. Now let us
move on to a little bit more sophisticated example.</p>

<h2 id="blabblr-one-to-many-publish-subscribe-pubsub-example">Blabblr: one-to-many publish/subscribe (pubsub) example</h2>

<p>The previous example demonstrated how a connection to a broker is made and how to do 1:1 communication using the default exchange. Now let us take a look at another common scenario: broadcast, or multiple consumers and one producer.</p>

<p>A very well-known broadcast example is Twitter: every time a person
tweets, followers receive a notification. Blabbr, our imaginary
information network, models this scenario: every network member has a
separate queue and publishes blabs to a separate exchange. Three
Blabbr members, Joe, Aaron and Bob, follow the official NBA account on
Blabbr to get updates about what is happening in the world of
basketball. Here is the code:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="s2">"amqp://127.0.0.1:5672"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="o">|</span>
  <span class="n">channel</span>  <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"nba.scores"</span><span class="p">)</span>

  <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"joe"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">payload</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2"> =&gt; joe"</span>
  <span class="k">end</span>

  <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"aaron"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">payload</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2"> =&gt; aaron"</span>
  <span class="k">end</span>

  <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"bob"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">payload</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2"> =&gt; bob"</span>
  <span class="k">end</span>

  <span class="n">exchange</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="s2">"BOS 101, NYK 89"</span><span class="p">).</span><span class="nf">publish</span><span class="p">(</span><span class="s2">"ORL 85, ALT 88"</span><span class="p">)</span>

  <span class="c1"># disconnect &amp; exit after 2 seconds</span>
  <span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">exchange</span><span class="p">.</span><span class="nf">delete</span>

    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The first line has a few differences from the &quot;Hello, world&quot; example above:</p>

<ul>
<li>We use <code>AMQP.start</code> instead of <code>AMQP.connect</code></li>
<li>Instead of return values, we pass a block to the connection method and it yields a connection
object back as soon as the connection is established.</li>
<li>Instead of passing connection parameters as a hash, we use a URI string.</li>
</ul>

<p><code>AMQP.start</code> is just a convenient way to do</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="o">|</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The <code>AMQP.start</code> call blocks the current thread which
means that its use is limited to scripts and small command line
applications. Blabbr is just that.</p>

<p><code>AMQP.connect</code>, when invoked with a block, will yield a
connection object as soon as the AMQP connection is open. Finally,
connection parameters may be supplied as a Hash or as a connection
string. The <code>AMQP.connect</code> method documentation contains all of the
details.</p>

<p>In this example, opening a channel is no different to opening a
channel in the previous example, however, the exchange is declared
differently</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"nba.scores"</span><span class="p">)</span>
</code></pre></div>
<p>The exchange that we declare above using <code>AMQP::Channel#fanout</code> is a <em>fanout exchange</em>. A fanout exchange delivers messages to all of the queues that are bound to it: exactly what we want in the case of Blabbr!</p>

<p>This piece of code</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"joe"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">payload</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2"> =&gt; joe"</span>
<span class="k">end</span>
</code></pre></div>
<p>is similar to the subscription code that we used for message delivery previously, but what does that <code>AMQP::Queue#bind</code> method do? It sets up a binding between the queue and the exchange that you pass to it. We need to do this to make sure that our fanout exchange routes messages to the queues of any subscribed followers.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">exchange</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="s2">"BOS 101, NYK 89"</span><span class="p">).</span><span class="nf">publish</span><span class="p">(</span><span class="s2">"ORL 85, ALT 88"</span><span class="p">)</span>
</code></pre></div>
<p>demonstrates <code>AMQP::Exchange#publish</code> call chaining. Blabbr members use a fanout exchange for publishing, so there is no need to specify a message routing key because every queue that is bound to the exchange will get its own copy of all messages, regardless of the queue name and routing key used.</p>

<p>A diagram for Blabbr looks like this:</p>

<p>!<a href="https://github.com/ruby-amqp/amqp/raw/master/docs/diagrams/002_blabbr_example_routing.png">https://github.com/ruby-amqp/amqp/raw/master/docs/diagrams/002_blabbr_example_routing.png</a>!</p>

<p>Next we use EventMachine&#39;s <a href="http://eventmachine.rubyforge.org/EventMachine.html#M000466">add_timer</a> method to run a piece of code in 1 second from now:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">exchange</span><span class="p">.</span><span class="nf">delete</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>The code that we want to run deletes the exchange that we declared earlier using <code>AMQP::Exchange#delete</code> and closes the AMQP connection with <code>AMQP::Session#close</code>. Finally, we stop the EventMachine event loop and exit.</p>

<p>Blabbr is pretty unlikely to secure hundreds of millions of dollars in funding, but it does a pretty good job of demonstrating how one can use AMQP fanout exchanges to do broadcasting.</p>

<h2 id="weathr-many-to-many-topic-routing-example">Weathr: many-to-many topic routing example</h2>

<p>So far, we have seen point-to-point communication and broadcasting. Those two communication styles are possible with many protocols, for instance, HTTP handles these scenarios just fine. You may ask &quot;what differentiates AMQP?&quot; Well, next we are going to introduce you to <em>topic exchanges</em> and routing with patterns, one of the features that makes AMQP very powerful.</p>

<p>Our third example involves weather condition updates. What makes it different from the previous two examples is that not all of the consumers are interested in all of the messages. People who live in Portland usually do not care about the weather in Hong Kong (unless they are visiting soon). They are much more interested in weather conditions around Portland, possibly all of Oregon and sometimes a few neighbouring states.</p>

<p>Our example features multiple consumer applications monitoring updates for different regions. Some are interested in updates for a specific city, others for a specific state and so on, all the way up to continents. Updates may overlap so that an update for San Diego, CA appears as an update for California, but also should show up on the North America updates list.</p>

<p>Here is the code:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="o">|</span>
    <span class="n">channel</span>  <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="c1"># topic exchange name can be any string</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">topic</span><span class="p">(</span><span class="s2">"weathr"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>

    <span class="c1"># Subscribers.</span>
    <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="ss">:exclusive</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">queue</span><span class="o">|</span>
      <span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.north.#"</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
        <span class="nb">puts</span> <span class="s2">"An update for North America: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, routing key is </span><span class="si">#{</span><span class="n">headers</span><span class="p">.</span><span class="nf">routing_key</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"americas.south"</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.south.#"</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">"An update for South America: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, routing key is </span><span class="si">#{</span><span class="n">headers</span><span class="p">.</span><span class="nf">routing_key</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
    <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"us.california"</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.north.us.ca.*"</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">"An update for US/California: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, routing key is </span><span class="si">#{</span><span class="n">headers</span><span class="p">.</span><span class="nf">routing_key</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
    <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"us.tx.austin"</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"#.tx.austin"</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">"An update for Austin, TX: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, routing key is </span><span class="si">#{</span><span class="n">headers</span><span class="p">.</span><span class="nf">routing_key</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
    <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"it.rome"</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"europe.italy.rome"</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">"An update for Rome, Italy: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, routing key is </span><span class="si">#{</span><span class="n">headers</span><span class="p">.</span><span class="nf">routing_key</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
    <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"asia.hk"</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"asia.southeast.hk.#"</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">"An update for Hong Kong: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, routing key is </span><span class="si">#{</span><span class="n">headers</span><span class="p">.</span><span class="nf">routing_key</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>

    <span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">exchange</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="s2">"San Diego update"</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.north.us.ca.sandiego"</span><span class="p">).</span>
        <span class="nf">publish</span><span class="p">(</span><span class="s2">"Berkeley update"</span><span class="p">,</span>         <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.north.us.ca.berkeley"</span><span class="p">).</span>
        <span class="nf">publish</span><span class="p">(</span><span class="s2">"San Francisco update"</span><span class="p">,</span>    <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.north.us.ca.sanfrancisco"</span><span class="p">).</span>
        <span class="nf">publish</span><span class="p">(</span><span class="s2">"New York update"</span><span class="p">,</span>         <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.north.us.ny.newyork"</span><span class="p">).</span>
        <span class="nf">publish</span><span class="p">(</span><span class="s2">"SÃ£o Paolo update"</span><span class="p">,</span>        <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.south.brazil.saopaolo"</span><span class="p">).</span>
        <span class="nf">publish</span><span class="p">(</span><span class="s2">"Hong Kong update"</span><span class="p">,</span>        <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"asia.southeast.hk.hongkong"</span><span class="p">).</span>
        <span class="nf">publish</span><span class="p">(</span><span class="s2">"Kyoto update"</span><span class="p">,</span>            <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"asia.southeast.japan.kyoto"</span><span class="p">).</span>
        <span class="nf">publish</span><span class="p">(</span><span class="s2">"Shanghai update"</span><span class="p">,</span>         <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"asia.southeast.prc.shanghai"</span><span class="p">).</span>
        <span class="nf">publish</span><span class="p">(</span><span class="s2">"Rome update"</span><span class="p">,</span>             <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"europe.italy.roma"</span><span class="p">).</span>
        <span class="nf">publish</span><span class="p">(</span><span class="s2">"Paris update"</span><span class="p">,</span>            <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"europe.france.paris"</span><span class="p">)</span>
    <span class="k">end</span>


    <span class="n">show_stopper</span> <span class="o">=</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span>
      <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">show_stopper</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The first line that is different from the Blabbr example is</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">topic</span><span class="p">(</span><span class="s2">"weathr"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</code></pre></div>
<p>We use a topic exchange here. Topic exchanges are used for <a href="http://en.wikipedia.org/wiki/Multicast">multicast</a> messaging where consumers indicate which topics they are interested in (think of it as subscribing to a feed for an individual tag in your favourite blog as opposed to the full feed). Routing with a topic exchange is done by specifying a <em>routing pattern</em> on binding, for example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"americas.south"</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.south.#"</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"An update for South America: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, routing key is </span><span class="si">#{</span><span class="n">headers</span><span class="p">.</span><span class="nf">routing_key</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div>
<p>Here we bind a queue with the name of &quot;americas.south&quot; to the topic exchange declared earlier using the <code>AMQP::Queue#bind</code> method.  This means that only messages with a routing key matching &quot;americas.south.#&quot; will be routed to that queue. A routing pattern consists of several words separated by dots, in a similar way to URI path segments joined by slashes. Here are a few examples:</p>

<ul>
<li>asia.southeast.thailand.bangkok</li>
<li>sports.basketball</li>
<li>usa.nasdaq.aapl</li>
<li>tasks.search.indexing.accounts</li>
</ul>

<p>Now let us take a look at a few routing keys that match the &quot;americas.south.#&quot; pattern:</p>

<ul>
<li>americas.south</li>
<li>americas.south.<em>brazil</em></li>
<li>americas.south.<em>brazil.saopaolo</em></li>
<li>americas.south.<em>chile.santiago</em></li>
</ul>

<p>In other words, the &quot;#&quot; part of the pattern matches 0 or more words.</p>

<p>For a pattern like &quot;americas.south.*&quot;, some matching routing keys would be:</p>

<ul>
<li>americas.south.<em>brazil</em></li>
<li>americas.south.<em>chile</em></li>
<li>americas.south.<em>peru</em></li>
</ul>

<p>but not</p>

<ul>
<li>americas.south</li>
<li>americas.south.chile.santiago</li>
</ul>

<p>so &quot;*&quot; only matches a single word. The AMQP 0.9.1 specification says that topic segments (words) may contain the letters A-Z and a-z and digits 0-9.</p>

<p>A (very simplistic) diagram to demonstrate topic exchange in action:</p>

<p>!<a href="https://github.com/ruby-amqp/amqp/raw/master/docs/diagrams/003_weathr_example_routing.png">https://github.com/ruby-amqp/amqp/raw/master/docs/diagrams/003_weathr_example_routing.png</a>!</p>

<p>One more thing that is different from previous examples is that the block we pass to <code>AMQP::Queue#subscribe</code> now takes two arguments: a <em>header</em> and a <em>body</em> (often called the <em>payload</em>). Long story short, the header parameter lets you access metadata associated with the message. Some examples of message metadata attributes are:</p>

<ul>
<li>message content type</li>
<li>message content encoding</li>
<li>message priority</li>
<li>message expiration time</li>
<li>message identifier</li>
<li>reply to (specifies which message this is a reply to)</li>
<li>application id (identifier of the application that produced the message)</li>
</ul>

<p>and so on.</p>

<p>As the following binding demonstrates, &quot;#&quot; and &quot;*&quot; can also appear at the beginning of routing patterns:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"us.tx.austin"</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"#.tx.austin"</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"An update for Austin, TX: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, routing key is </span><span class="si">#{</span><span class="n">headers</span><span class="p">.</span><span class="nf">routing_key</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div>
<p>For this example the publishing of messages is no different from that of previous examples. If we were to run the program, a message published with a routing key of &quot;americas.north.us.ca.berkeley&quot; would be routed to 2 queues: &quot;us.california&quot; and the <em>server-named queue</em> that we declared by passing a blank string as the name:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="ss">:exclusive</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">queue</span><span class="o">|</span>
  <span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"americas.north.#"</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"An update for North America: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, routing key is </span><span class="si">#{</span><span class="n">headers</span><span class="p">.</span><span class="nf">routing_key</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The name of the server-named queue is generated by the broker and sent
back to the client with a queue declaration confirmation. Because the
queue name is not known before the reply arrives, we pass
<code>AMQP::Channel#queue</code> a callback and it yields us back a queue object
once confirmation has arrived.</p>

<h3 id="avoid-race-conditions">Avoid race conditions</h3>

<p>A word of warning: you may find examples on the Web of <code>AMQP::Channel#queue</code> usage that do not use callbacks. We <em>recommend
that you use a callback for server-named queues</em>, otherwise your code
may be subject to <a href="http://en.wikipedia.org/wiki/Race_condition">race
conditions</a>. Even though
the amqp gem tries to be reasonably smart and protect you from most
common problems (for example, binding operations will be delayed until
after queue name is received from the broker), there is no way it can
do so for every case. The primary reason for supporting <code>AMQP::Channel#queue</code> usage without a callback for server-Âµnamed
queues is backwards compatibility with earlier versions of the gem.</p>

<h2 id="integration-with-objects">Integration with objects</h2>

<p>Since Ruby is a genuine object-oriented language, it is important to demonstrate how the Ruby amqp gem can be integrated into rich object-oriented code.</p>

<p>The <code>AMQP::Queue#subscribe</code> callback does not have to be
a block. It can be any Ruby object that responds to <code>call</code>. A common
technique is to combine
<a href="http://rubydoc.info/stdlib/core/1.9.3/Object:method">Object#method</a>
and
<a href="http://rubydoc.info/stdlib/core/1.9.3/Method:to_proc">Method#to_proc</a>
and use object methods as message handlers.</p>

<p>An example to demonstrate this technique:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Consumer</span>

  <span class="c1">#</span>
  <span class="c1"># API</span>
  <span class="c1">#</span>

  <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Received a message: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, content_type = </span><span class="si">#{</span><span class="n">metadata</span><span class="p">.</span><span class="nf">content_type</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span> <span class="c1"># handle_message(metadata, payload)</span>
<span class="k">end</span>


<span class="k">class</span> <span class="nc">Worker</span>

  <span class="c1">#</span>
  <span class="c1"># API</span>
  <span class="c1">#</span>


  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">queue_name</span> <span class="o">=</span> <span class="no">AMQ</span><span class="o">::</span><span class="no">Protocol</span><span class="o">::</span><span class="no">EMPTY_STRING</span><span class="p">,</span> <span class="n">consumer</span> <span class="o">=</span> <span class="no">Consumer</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
    <span class="vi">@queue_name</span> <span class="o">=</span> <span class="n">queue_name</span>

    <span class="vi">@channel</span>    <span class="o">=</span> <span class="n">channel</span>
    <span class="vi">@channel</span><span class="p">.</span><span class="nf">on_error</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">method</span><span class="p">(</span><span class="ss">:handle_channel_exception</span><span class="p">))</span>

    <span class="vi">@consumer</span>   <span class="o">=</span> <span class="n">consumer</span>
  <span class="k">end</span> <span class="c1"># initialize</span>

  <span class="k">def</span> <span class="nf">start</span>
    <span class="vi">@queue</span> <span class="o">=</span> <span class="vi">@channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="vi">@queue_name</span><span class="p">,</span> <span class="ss">:exclusive</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
    <span class="vi">@queue</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@consumer</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="ss">:handle_message</span><span class="p">))</span>
  <span class="k">end</span> <span class="c1"># start</span>



  <span class="c1">#</span>
  <span class="c1"># Implementation</span>
  <span class="c1">#</span>

  <span class="k">def</span> <span class="nf">handle_channel_exception</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">channel_close</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Oops... a channel-level exception: code = </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_code</span><span class="si">}</span><span class="s2">, message = </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_text</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span> <span class="c1"># handle_channel_exception(channel, channel_close)</span>
<span class="k">end</span>
</code></pre></div>
<p>The &quot;Hello, world&quot; example can be ported to use this technique:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="k">class</span> <span class="nc">Consumer</span>

  <span class="c1">#</span>
  <span class="c1"># API</span>
  <span class="c1">#</span>

  <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Received a message: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, content_type = </span><span class="si">#{</span><span class="n">metadata</span><span class="p">.</span><span class="nf">content_type</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span> <span class="c1"># handle_message(metadata, payload)</span>
<span class="k">end</span>


<span class="k">class</span> <span class="nc">Worker</span>

  <span class="c1">#</span>
  <span class="c1"># API</span>
  <span class="c1">#</span>


  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">queue_name</span> <span class="o">=</span> <span class="no">AMQ</span><span class="o">::</span><span class="no">Protocol</span><span class="o">::</span><span class="no">EMPTY_STRING</span><span class="p">,</span> <span class="n">consumer</span> <span class="o">=</span> <span class="no">Consumer</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
    <span class="vi">@queue_name</span> <span class="o">=</span> <span class="n">queue_name</span>

    <span class="vi">@channel</span>    <span class="o">=</span> <span class="n">channel</span>
    <span class="vi">@channel</span><span class="p">.</span><span class="nf">on_error</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">method</span><span class="p">(</span><span class="ss">:handle_channel_exception</span><span class="p">))</span>

    <span class="vi">@consumer</span>   <span class="o">=</span> <span class="n">consumer</span>
  <span class="k">end</span> <span class="c1"># initialize</span>

  <span class="k">def</span> <span class="nf">start</span>
    <span class="vi">@queue</span> <span class="o">=</span> <span class="vi">@channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="vi">@queue_name</span><span class="p">,</span> <span class="ss">:exclusive</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
    <span class="vi">@queue</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@consumer</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="ss">:handle_message</span><span class="p">))</span>
  <span class="k">end</span> <span class="c1"># start</span>



  <span class="c1">#</span>
  <span class="c1"># Implementation</span>
  <span class="c1">#</span>

  <span class="k">def</span> <span class="nf">handle_channel_exception</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">channel_close</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Oops... a channel-level exception: code = </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_code</span><span class="si">}</span><span class="s2">, message = </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_text</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span> <span class="c1"># handle_channel_exception(channel, channel_close)</span>
<span class="k">end</span>


<span class="k">class</span> <span class="nc">Producer</span>

  <span class="c1">#</span>
  <span class="c1"># API</span>
  <span class="c1">#</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">exchange</span><span class="p">)</span>
    <span class="vi">@channel</span>  <span class="o">=</span> <span class="n">channel</span>
    <span class="vi">@exchange</span> <span class="o">=</span> <span class="n">exchange</span>
  <span class="k">end</span> <span class="c1"># initialize(channel, exchange)</span>

  <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@exchange</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">end</span> <span class="c1"># publish(message, options = {})</span>


  <span class="c1">#</span>
  <span class="c1"># Implementation</span>
  <span class="c1">#</span>

  <span class="k">def</span> <span class="nf">handle_channel_exception</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">channel_close</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Oops... a channel-level exception: code = </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_code</span><span class="si">}</span><span class="s2">, message = </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_text</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span> <span class="c1"># handle_channel_exception(channel, channel_close)</span>
<span class="k">end</span>


<span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="s2">"amqp://guest:guest@dev.rabbitmq.com"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="p">,</span> <span class="n">open_ok</span><span class="o">|</span>
  <span class="n">channel</span>  <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">worker</span>   <span class="o">=</span> <span class="no">Worker</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="s2">"amqpgem.objects.integration"</span><span class="p">)</span>
  <span class="n">worker</span><span class="p">.</span><span class="nf">start</span>

  <span class="n">producer</span> <span class="o">=</span> <span class="no">Producer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">channel</span><span class="p">.</span><span class="nf">default_exchange</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Publishing..."</span>
  <span class="n">producer</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="s2">"Hello, world"</span><span class="p">,</span> <span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">"amqpgem.objects.integration"</span><span class="p">)</span>

  <span class="c1"># stop in 2 seconds</span>
  <span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="p">{</span> <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>The most important line in this example is</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="vi">@queue</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@consumer</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="ss">:handle_message</span><span class="p">))</span>
</code></pre></div>
<p>Ampersand (&amp;) preceding an object is equivalent to calling the #to_proc method on it. We obtain a Consumer#handle_message method reference with</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="vi">@consumer</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="ss">:handle_message</span><span class="p">)</span>
</code></pre></div>
<p>and then the ampersand calls #to_proc on it. <code>AMQP::Queue#subscribe</code> then will be using this Proc instance to
handle incoming messages.</p>

<p>Note that the <code>Consumer</code> class above can be easily tested in isolation, without spinning up any AMQP connections.
Here is one example using <a href="http://relishapp.com/rspec">RSpec</a></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"ostruct"</span>
<span class="nb">require</span> <span class="s2">"json"</span>

<span class="c1"># RSpec example</span>
<span class="n">describe</span> <span class="no">Consumer</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">"when a new message arrives"</span> <span class="k">do</span>
    <span class="n">subject</span> <span class="p">{</span> <span class="n">described_class</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:metadata</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">o</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="p">.</span><span class="nf">new</span>

      <span class="n">o</span><span class="p">.</span><span class="nf">content_type</span> <span class="o">=</span> <span class="s2">"application/json"</span>
      <span class="n">o</span>
    <span class="k">end</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span>  <span class="p">{</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">encode</span><span class="p">({</span> <span class="ss">:command</span> <span class="o">=&gt;</span> <span class="s2">"reload_config"</span> <span class="p">})</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"does some useful work"</span> <span class="k">do</span>
      <span class="c1"># check preconditions here if necessary</span>

      <span class="n">subject</span><span class="p">.</span><span class="nf">handle_message</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

      <span class="c1"># add your code expectations here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h2 id="wrapping-up">Wrapping up</h2>

<p>This is the end of the tutorial. Congratulations! You have learned quite a bit about both AMQP 0.9.1 and the amqp gem. This is only the tip of the iceberg. AMQP has many more features built into the protocol:</p>

<ul>
<li>Reliable delivery of messages</li>
<li>Message confirmations (a way to tell broker that a message was or was not processed successfully)</li>
<li>Message redelivery when consumer applications fail or crash</li>
<li>Load balancing of messages between multiple consumers</li>
<li>Message metadata attributes</li>
</ul>

<p>and so on. Other guides explain these features in depth, as well as use cases for them. To stay up to date with amqp gem development, <a href="http://twitter.com/rubyamqp">follow @rubyamqp on Twitter</a> and <a href="http://groups.google.com/group/ruby-amqp">join our mailing list</a>.</p>

<h2 id="what-to-read-next">What to read next</h2>

<p>Documentation is organized as a number of <a href="/">documentation guides</a>, covering all kinds of topics from <a href="/articles/working_with_exchanges/">use cases for various exchange types</a> to <a href="/articles/error_handling/">error handling</a> and <a href="/articles/broker_specific_extensions/">Broker-specific AMQP 0.9.1 extensions</a>.</p>

<p>We recommend that you read the following guides next, if possible, in this order:</p>

<ul>
<li><a href="http://www.rabbitmq.com/tutorials/amqp-concepts.html">AMQP 0.9.1 Model Explained</a>. A simple 2 page long introduction to the AMQP Model concepts and features. Understanding the AMQP Model
will make a lot of other documentation, both for the Ruby amqp gem and RabbitMQ itself, easier to follow. With this guide, you don&#39;t have to waste hours of time reading the whole specification.</li>
<li><a href="/articles/connecting_to_broker/">Connection to the broker</a>. This guide explains how to connect to an AMQP broker and how to integrate the amqp gem into standalone and Web applications.</li>
<li><a href="/articles/working_with_queues/">Working With Queues</a>. This guide focuses on features that consumer applications use heavily.</li>
<li><a href="/articles/working_with_exchanges/">Working With Exchanges</a>. This guide focuses on features that producer applications use heavily.</li>
<li><a href="/articles/patterns_and_use_cases/">Patterns &amp; Use Cases</a>. This guide focuses implementation of <a href="http://www.eaipatterns.com/">common messaging patterns</a> using AMQP Model features as building blocks.</li>
<li><a href="/articles/error_handling/">Error Handling &amp; Recovery</a>. This guide explains how to handle protocol errors, network failures and other things that may go wrong in real world projects.</li>
</ul>

<p>If you are migrating your application from earlier versions of the
amqp gem (0.6.x and 0.7.x), to 0.8.x and later, there is the <a href="/articles/08_migration/">amqp gem
0.8 migration guide</a>.</p>

        </div>
      </div>
    <footer class='footer'>
      <div class='container'>
        <p>This website was developed by the
          &nbsp;<a href='http://github.com/ruby-amqp'>Ruby RabbitMQ Client Maintainers Team</a>.</p>
        <p>Follow us on Twitter:
          &nbsp;<a href='http://twitter.com/rubyamqp'>rubyamqp</a>,&nbsp;<a href='http://twitter.com/michaelklishin'>Michael Klishin</a>,&nbsp;<a href='http://twitter.com/celldee'>Chris Duncan</a></p>
      </div>
    </footer>
  </body>
</html>
