<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en'>
  <head>
    <title>Troubleshooting RabbitMQ applications</title>
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <meta content='A dead easy to use RabbitMQ Ruby client' name='description' />
    <meta content='The Ruby RabbitMQ Client Maintainers Team' name='author' />
    <link href='/assets/stylesheets/bootstrap.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/bootstrap-responsive.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/sass/styles.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='http://fonts.googleapis.com/css?family=Signika+Negative:300,400,600' rel='stylesheet' type='text/css' />
    <script src='/assets/javascripts/jquery-1.7.min.js' type='text/javascript'></script>
    <script src='/assets/javascripts/toc.js'></script>
    <script src='/assets/javascripts/bootstrap-collapse.js'></script>
    <meta content='text/html;charset=utf-8' http-equiv='Content-Type' />
    <script type="text/javascript">
      if(!(window.location.hostname === "localhost")) {
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-27153041-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
      }
    </script>
  </head>

  <body>
    <div class='navbar navbar-inverse navbar-fixed-top'>
      <div class='navbar-inner'>
        <div class='container-fluid'>
          <a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </a>
          <a class='brand' href='/'>Ruby amqp gem</a>
          <div class='nav-collapse'>
            <ul class='nav'>
            <li>
              <a href="/">Home</a>
            </li>
            <li>
              <a href="/articles/guides.html">All guides</a>
            </li>
            <li>
              <a href='/articles/community.html'>Community</a>
            </li>
            <li>
              <a href='http://rubybunny.info'>Bunny, an alternative client</a>
            </li>
            <li>
              <a href='https://github.com/ruby-amqp/amqp'>Code on Github</a>
            </li>
            <li>
              <a href='http://github.com/ruby-amqp'>Other RabbitMQ Ruby clients</a>
            </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class='container-fluid'>
      <div class='row-fluid'>
        <div class='span3'>
          <div class='well sidebar-nav'></div>
        </div>
        <div class='span9'>
          <h1>Troubleshooting RabbitMQ applications</h1>
          <h2 id="about-this-guide">About this guide</h2>

<p>This guide describes tools and strategies that help in troubleshooting
and debugging applications that use RabbitMQ in general and the <a href="http://github.com/ruby-amqp/amqp">Ruby amqp
gem</a> in particular.</p>

<h2 id="covered-versions">Covered versions</h2>

<p>This guide covers Ruby amqp gem 1.7.0 and later versions.</p>

<h2 id="first-steps">First steps</h2>

<p>Whenever something doesn’t work, check the following things before
asking on the mailing list:</p>

<ul>
<li>RabbitMQ log.</li>
<li>List of users in a particular vhost you are trying to connect</li>
<li>Network connectivity. We know, it’s obvious, yet even experienced
developers and devops engineers struggle with network access
misconfigurations every once in a while.</li>
<li>If EventMachine is started in a separate thread, make sure that it
isn’t dead. If it is, this usually means that there was an exception
that caused it to terminate, or the environment uses the fork(2) system
call.</li>
</ul>

<h2 id="inspecting-rabbitmq-log-file">Inspecting RabbitMQ log file</h2>

<p>In this section we will cover typical problems that can be tracked down
by reading the RabbitMQ log.</p>

<p>RabbitMQ logs abrupt TCP connection failures, timeouts, protocol version
mismatches and so on. If you are running RabbitMQ, log locations for
various operating systems and distributions are documented in the
<a href="http://www.rabbitmq.com/install.html">RabbitMQ installation guide</a></p>

<p>On Mac OS X, RabbitMQ installed via Homebrew logs to
\$HOMEBREW_HOME/var/log/rabbitmq/rabbit@\$HOSTNAME.log. For example, if
you have Homebrew installed at /usr/local and your hostname is giove,
the log will be at /usr/local/var/log/rabbitmq/<a href="mailto:rabbit@giove.log">rabbit@giove.log</a>.</p>

<p>Here is what authentication failure looks like in a RabbitMQ log:</p>
<div class="highlight"><pre><code class="language-" data-lang="">=ERROR REPORT 17-May-2011::17:37:58 =
exception on TCP connection &lt;0.4770.0&gt; from 127.0.0.1:46551
{channel0_error,starting,
                {amqp_error,access_refused,
                            "AMQPLAIN login refused: user 'pipeline_agent' - invalid credentials",
                            'connection.start_ok'}}
</code></pre></div>
<p>This means that the connection attempt with username pipeline_agent failed because the credentials were invalid. If you are seeing this message, make sure username, password <em>and vhost</em> are correct.</p>

<p>The following entry:</p>
<div class="highlight"><pre><code class="language-" data-lang="">=ERROR REPORT 17-May-2011::17:26:28 =
exception on TCP connection &lt;0.4201.62&gt; from 10.8.0.30:57990
{bad_header,&lt;&lt;65,77,81,80,0,0,9,1&gt;&gt;}
</code></pre></div>
<p>means that the client supports AMQP 0.9.1 but the broker doesn’t
(RabbitMQ versions pre-2.0 only support AMQP 0.8, for example). If you
are using amqp gem 0.8 or later and seeing this entry in your broker
log, you are connecting to an RabbitMQ that is too old to support
this amqp gem version. In the case of RabbitMQ, make sure that you run
version 2.0 or later.</p>

<h2 id="handling-channel-level-exceptions">Handling channel-level exceptions</h2>

<p>A broad range of problems result in AMQP channel exceptions: an
indication by the broker that there was an issue that the application
needs to be aware of. Channel-level exceptions are typically not fatal
and can be recovered from. Some examples are:</p>

<ul>
<li>Exchange is re-declared with attributes different from the original
declaration. For example, a non-durable exchange is being re-declared as
durable.

<ul>
<li>Queue is re-declared with attributes different from the original
declaration. For example, an auto-deletable queue is being re-declared
as non-auto-deletable.</li>
<li>Queue is bound to an exchange that does not exist.</li>
</ul></li>
</ul>

<p>and so on. When troubleshooting RabbitMQ applications, it is recommended
that you detect and handle channel-level exceptions on all of the
channels that your application may use. For that, use the
<code>AMQP::Channel#on_error</code> method as demonstrated below:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">events_channel</span><span class="p">.</span><span class="nf">on_error</span> <span class="k">do</span> <span class="o">|</span><span class="n">ch</span><span class="p">,</span> <span class="n">channel_close</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"Channel-level exception on the events channel: </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_text</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="n">commands_channel</span><span class="p">.</span><span class="nf">on_error</span> <span class="k">do</span> <span class="o">|</span><span class="n">ch</span><span class="p">,</span> <span class="n">channel_close</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"Channel-level exception on the commands channel: </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_text</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div>
<p>Defining channel-level exception handlers will reveal many issues that
it might take more time to detect using other troubleshooting
techniques.</p>

<h2 id="testing-network-connection-with-rabbitmq-using-telnet">Testing network connection with RabbitMQ using Telnet</h2>

<p>One simple way to check network connection between a particular network
node and a node running an RabbitMQ is to use <code>telnet</code>:</p>
<div class="highlight"><pre><code class="language-" data-lang="">telnet [host or ip] 5672
</code></pre></div>
<p>then enter any random string of text and hit Enter. The RabbitMQ
should close the connection when you enter anything other than
supported protocol handshake. Here is an example
session:</p>
<div class="highlight"><pre><code class="language-" data-lang="">telnet localhost 5672
Connected to localhost.
Escape character is ‘^]’.
adjasd
AMQP Connection closed by foreign host.
</code></pre></div>
<p>If Telnet exits after printing instead</p>
<div class="highlight"><pre><code class="language-" data-lang="">telnet: connect to address [host or ip]: Connection refused
telnet: Unable to connect to remote host
</code></pre></div>
<p>then the connection between the machine that you are running Telnet
tests on and the RabbitMQ fails. This can be due to many different
reasons, but it is a good idea to check these two things first:</p>

<ul>
<li>Firewall configuration for port 5672</li>
<li>DNS setup (if hostname is used)</li>
</ul>

<h2 id="rabbitmq-startup-issues">RabbitMQ Startup Issues</h2>

<h3 id="missing-erlang-os-mon-on-debian-and-ubuntu">Missing erlang-os-mon on Debian and Ubuntu</h3>

<p>The following error on RabbitMQ startup on Debian or Ubuntu</p>
<div class="highlight"><pre><code class="language-" data-lang="">ERROR: failed to load application os_mon: {“no such file or
directory”,“os_mon.app”}
</code></pre></div>
<p>suggests that the <strong>erlang-os-mon</strong> package is not installed.</p>

        </div>
      </div>
    <footer class='footer'>
      <div class='container'>
        <p>This website was developed by the
          &nbsp;<a href='http://github.com/ruby-amqp'>Ruby RabbitMQ Client Maintainers Team</a>.</p>
        <p>Follow us on Twitter:
          &nbsp;<a href='http://twitter.com/rubyamqp'>rubyamqp</a>,&nbsp;<a href='http://twitter.com/michaelklishin'>Michael Klishin</a>,&nbsp;<a href='http://twitter.com/celldee'>Chris Duncan</a></p>
      </div>
    </footer>
  </body>
</html>
