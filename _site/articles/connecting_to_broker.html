<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en'>
  <head>
    <title>Connecting to the broker, integrating amqp gem with Ruby on Rails, Sinatra and Web apps</title>
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <meta content='A dead easy to use RabbitMQ Ruby client' name='description' />
    <meta content='The Ruby RabbitMQ Client Maintainers Team' name='author' />
    <link href='/assets/stylesheets/bootstrap.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/bootstrap-responsive.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/sass/styles.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='http://fonts.googleapis.com/css?family=Signika+Negative:300,400,600' rel='stylesheet' type='text/css' />
    <script src='/assets/javascripts/jquery-1.7.min.js' type='text/javascript'></script>
    <script src='/assets/javascripts/toc.js'></script>
    <script src='/assets/javascripts/bootstrap-collapse.js'></script>
    <meta content='text/html;charset=utf-8' http-equiv='Content-Type' />
    <script type="text/javascript">
      if(!(window.location.hostname === "localhost")) {
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-27153041-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
      }
    </script>
  </head>

  <body>
    <div class='navbar navbar-inverse navbar-fixed-top'>
      <div class='navbar-inner'>
        <div class='container-fluid'>
          <a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </a>
          <a class='brand' href='/'>Ruby amqp gem</a>
          <div class='nav-collapse'>
            <ul class='nav'>
            <li>
              <a href="/">Home</a>
            </li>
            <li>
              <a href="/articles/guides.html">All guides</a>
            </li>
            <li>
              <a href='/articles/community.html'>Community</a>
            </li>
            <li>
              <a href='http://rubybunny.info'>Bunny, an alternative client</a>
            </li>
            <li>
              <a href='https://github.com/ruby-amqp/amqp'>Code on Github</a>
            </li>
            <li>
              <a href='http://github.com/ruby-amqp'>Other RabbitMQ Ruby clients</a>
            </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class='container-fluid'>
      <div class='row-fluid'>
        <div class='span3'>
          <div class='well sidebar-nav'></div>
        </div>
        <div class='span9'>
          <h1>Connecting to the broker, integrating amqp gem with Ruby on Rails, Sinatra and Web apps</h1>
          <h2 id="about-this-guide">About this guide</h2>

<p>This guide covers connection to an AMQP broker from standalone and Web
applications, connection error handling, authentication failure handling
and related issues.</p>

<p>This work is licensed under a
<a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative
Commons Attribution 3.0 Unported License</a> (including images and
stylesheets). The source is available <a href="https://github.com/ruby-amqp/rubyamqp.info">on
Github</a>.</p>

<h2 id="which-versions-of-the-amqp-gem-does-this-guide-cover">Which versions of the amqp gem does this guide cover?</h2>

<p>This guide covers Ruby amqp gem 1.7.0 and later versions.</p>

<h2 id="terminology">Terminology</h2>

<p>In this guide we define a ‘standalone application’ as an application
that does not run on a Web server like Unicorn or Passenger. The key
difference is that these applications control the main Ruby VM thread
and often use it to run the <span class="highlight">EventMachine</span>
event loop. When the amqp gem is used in a Web application, the main
thread is occupied by the Web application server and the code required
to establish a connection to an AMQP broker needs to be a little bit
different.</p>

<h2 id="two-ways-to-specify-connection-parameters">Two ways to specify connection parameters</h2>

<p>Connection parameters (host, port, username, vhost and so on) can be
passed in two forms:</p>

<ul>
<li>As a hash</li>
<li>As a connection URI string (à la JDBC)</li>
</ul>

<h3 id="using-a-hash">Using a hash</h3>

<p>Hash options that the amqp gem will recognize are</p>

<ul>
<li>:host</li>
<li>:port</li>
<li>:username (aliased as :user)</li>
<li>:password (aliased as :pass)</li>
<li>:vhost</li>
<li>:ssl</li>
<li>:timeout (in seconds)</li>
<li>:heartbeat (in seconds), 0 means no heartbeat</li>
<li>:frame_max</li>
</ul>

<h4 id="default-parameters">Default parameters</h4>

<p>Default connection parameters are</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span>
  <span class="ss">:host</span>      <span class="o">=&gt;</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
  <span class="ss">:port</span>      <span class="o">=&gt;</span> <span class="mi">5672</span><span class="p">,</span>
  <span class="ss">:user</span>      <span class="o">=&gt;</span> <span class="s2">"guest"</span><span class="p">,</span>
  <span class="ss">:pass</span>      <span class="o">=&gt;</span> <span class="s2">"guest"</span><span class="p">,</span>
  <span class="ss">:vhost</span>     <span class="o">=&gt;</span> <span class="s2">"/"</span><span class="p">,</span>
  <span class="ss">:ssl</span>       <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
  <span class="ss">:heartbeat</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
  <span class="ss">:frame_max</span> <span class="o">=&gt;</span> <span class="mi">131072</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="using-connection-strings">Using connection strings</h3>

<p>It is convenient to be able to specify the AMQP connection parameters as
a URI string, and various “amqp” URI schemes exist. Unfortunately, there
is no standard for these URIs, so while the schemes share the same basic
idea, they differ in some details. This implementation aims to encourage
URIs that work as widely as possible.</p>

<p>Here are some examples:</p>

<ul>
<li>&quot;amqp://dev.rabbitmq.com&quot;</li>
<li>&quot;amqp://dev.rabbitmq.com:5672&quot;</li>
<li>&quot;amqp://guest:<a href="mailto:guest@dev.rabbitmq.com">guest@dev.rabbitmq.com</a>:5672&quot;</li>
<li>&quot;amqp://hedgehog:<a href="mailto:t0ps3kr3t@hub.megacorp.internal">t0ps3kr3t@hub.megacorp.internal</a>/production&quot;</li>
<li>&quot;amqps://hub.megacorp.internal/%2Fvault&quot;</li>
</ul>

<p>The URI scheme should be “amqp”, or “amqps” if SSL is required.</p>

<p>The host, port, username and password are represented in the authority
component of the URI in the same way as in http URIs.</p>

<p>The vhost is obtained from the first segment of the path, with the
leading slash removed. The path should contain only a single segment
(i.e, the only slash in it should be the leading one). If the vhost is
to include slashes or other reserved URI characters, these should be
percent-escaped.</p>

<p>Here are some examples that demonstrate how
<code>AMQP::Client.parse_connection_uri</code> parses out the vhost
from connection URIs:</p>
<div class="highlight"><pre><code class="language-" data-lang="">"amqp://dev.rabbitmq.com"            # =&gt; vhost is nil, so default ("/") will be used
"amqp://dev.rabbitmq.com/"           # =&gt; vhost is an empty string
"amqp://dev.rabbitmq.com/%2Fvault"   # =&gt; vhost is "/vault"
"amqp://dev.rabbitmq.com/production" # =&gt; vhost is "production"
"amqp://dev.rabbitmq.com/a.b.c"      # =&gt; vhost is "a.b.c"
"amqp://dev.rabbitmq.com/foo/bar"    # =&gt; ArgumentError
</code></pre></div>
<h2 id="starting-the-event-loop-and-connecting-in-standalone-applications">Starting the event loop and connecting in standalone applications</h2>

<h3 id="eventmachine-event-loop">EventMachine event loop</h3>

<p>The amqp gem uses <a href="http://rubyeventmachine.com">EventMachine</a> under the
hood and needs an EventMachine event loop to be running in order to
connect to an AMQP broker or to send any data. This means that before
connecting to an AMQP broker, we need to <em>start the EventMachine
reactor</em> (get the event loop going). Here is how to do it:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div>
<p><a href="http://eventmachine.rubyforge.org/EventMachine.html#M000461">EventMachine.run</a>
will block the current thread until the event loop is stopped.
Standalone applications often can afford to start the event loop on the
main thread. If you have no experience with threading, this is a
recommended way to proceed.</p>

<h3 id="using-amqp-connect-with-a-block">Using AMQP.connect with a block</h3>

<p>Once the event loop is running, the <code>AMQP.connect</code> method
will attempt to connect to the broker. It can be used in two ways. Here
is the first one:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="c1"># using AMQP.connect with a block</span>
  <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"localhost"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
    <span class="c1"># connection is open and ready to be used</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><code>AMQP.connect</code> takes a block that will be executed as soon
as the AMQP connection is open. In order for a connection to be opened a
TCP connection has to be set up, authentication has to succeed, and the
broker and client need to complete negotiation of connection parameters
like max frame size.</p>

<h3 id="using-amqp-connect-without-a-callback">Using AMQP.connect without a callback</h3>

<p>An alternative way of connecting is this:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="c1"># using AMQP.connect with a block</span>
  <span class="n">client</span> <span class="o">=</span> <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"hub.megacorp.internal"</span><span class="p">,</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="s2">"hedgehog"</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">"t0ps3kr3t"</span><span class="p">)</span>
  <span class="c1"># connection is not yet open, however, amqp gem will delay channel</span>
  <span class="c1"># operations until after the connection is open. Bear in mind that</span>
  <span class="c1"># amqp gem cannot solve every possible race condition so be careful</span>
<span class="k">end</span>
</code></pre></div>
<p>If you do not need to assign the returned value to a variable, then the
“block version” is recommended because it eliminates issues that may
arise from attempts to use a connection object that is not fully opened.
For example, handling of authentication failures is simpler with the
block version, as we will see in the following sections.</p>

<h3 id="using-amqp-start">Using AMQP.start</h3>

<p>EventMachine.run and <code>AMQP.connect</code> with a block is such a
common combination that the amqp gem provides a shortcut:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="s2">"amqp://dev.rabbitmq.com:5672"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
  <span class="c1"># connection is open and ready to be used</span>
<span class="k">end</span>
</code></pre></div>
<p>As these examples demonstrate, <code>AMQP.connect</code> and
<code>AMQP.start</code> accept either a Hash of connection options or
a connection URI string.</p>

<p>See the reference documentation for each method to learn all of the
options that they accept and what the default values are.</p>

<h3 id="on-thread-sleep-use">On Thread#sleep use</h3>

<p>When not passing a block to <code>AMQP.connect</code>, it is tempting
to “give the connection some time to become established” by using
<code>Thread#sleep</code>. Unless you are running the event loop in a separate
thread, please do not do this. <code>Thread#sleep</code> blocks the calling thread
so that if the event loop is running in the current thread, blocking the
thread <em>will also block the event loop</em>. <strong>When the event loop is
blocked, no data is sent or received, so the connection does not
proceed.</strong></p>

<h3 id="detecting-tcp-connection-failures">Detecting TCP connection failures</h3>

<p>When applications connect to the broker, they need to handle
connection failures. Networks are not 100 reliable and even with
modern system configuration tools, like
<a href="http://http://www.opscode.com/chef">Chef</a> or
<a href="http://http://www.puppetlabs.com">Puppet</a>, misconfigurations can
happen. Also, the broker might be down for some reason. Ideally, error
detection should happen as early as possible. There are two ways of
detecting TCP connection failure, the first one is to catch an
exception:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>


<span class="nb">puts</span> <span class="s2">"=&gt; TCP connection failure handling with a rescue statement"</span>
<span class="nb">puts</span>

<span class="n">connection_settings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">:port</span>     <span class="o">=&gt;</span> <span class="mi">9689</span><span class="p">,</span>
  <span class="ss">:vhost</span>    <span class="o">=&gt;</span> <span class="s2">"/amq_client_testbed"</span><span class="p">,</span>
  <span class="ss">:user</span>     <span class="o">=&gt;</span> <span class="s2">"amq_client_gem"</span><span class="p">,</span>
  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">"amq_client_gem_password"</span><span class="p">,</span>
  <span class="ss">:timeout</span>  <span class="o">=&gt;</span> <span class="mf">0.3</span>
<span class="p">}</span>

<span class="k">begin</span>
  <span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">connection_settings</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="p">,</span> <span class="n">open_ok</span><span class="o">|</span>
    <span class="k">raise</span> <span class="s2">"This should not be reachable"</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">TCPConnectionFailed</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="s2">"Caught AMQP::TCPConnectionFailed =&gt; TCP connection failed, as expected."</span>
<span class="k">end</span>
</code></pre></div>
<p><code>AMQP.connect</code> (and <code>AMQP.start</code>) will raise
<code>AMQP::TCPConnectionFailed</code> if the connection fails. Code that catches
the error can write to a log about the issue or use retry to execute
the begin block one more time. Because initial connection failures are
due to misconfiguration or network outage, reconnection to the same
endpoint (hostname, port, vhost combination) will result in the same
error over and over again.</p>

<p>An alternative way of handling connection failure is with an <em>errback</em>
(a callback for a specific kind of error):</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="nb">puts</span> <span class="s2">"=&gt; TCP connection failure handling with a callback"</span>
<span class="nb">puts</span>

<span class="n">handler</span>             <span class="o">=</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">settings</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"Failed to connect, as expected"</span><span class="p">;</span> <span class="no">EM</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">:port</span>     <span class="o">=&gt;</span> <span class="mi">9689</span><span class="p">,</span>
  <span class="ss">:vhost</span>    <span class="o">=&gt;</span> <span class="s2">"/amq_client_testbed"</span><span class="p">,</span>
  <span class="ss">:user</span>     <span class="o">=&gt;</span> <span class="s2">"amq_client_gem"</span><span class="p">,</span>
  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">"amq_client_gem_password"</span><span class="p">,</span>
  <span class="ss">:timeout</span>  <span class="o">=&gt;</span> <span class="mf">0.3</span><span class="p">,</span>
  <span class="ss">:on_tcp_connection_failure</span> <span class="o">=&gt;</span> <span class="n">handler</span>
<span class="p">}</span>


<span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">connection_settings</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="p">,</span> <span class="n">open_ok</span><span class="o">|</span>
  <span class="k">raise</span> <span class="s2">"This should not be reachable"</span>
<span class="k">end</span>
</code></pre></div>
<p>the <span class="note">:on_tcp_connection_failure</span> option
accepts any object that responds to <code>#call</code>.</p>

<p>If you connect to the broker from code in a class (as opposed to
top-level scope in a script), <code>Object#method</code> can be used to pass an
object method as a handler instead of a Proc.</p>

<p>TBD: provide an example</p>

<h3 id="detecting-authentication-failures">Detecting authentication failures</h3>

<p>A connection may also fail due to authentication failure. Handling
authentication failure is very similar to handling an initial TCP
connection failure:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="nb">puts</span> <span class="s2">"=&gt; Authentication failure handling with a callback"</span>
<span class="nb">puts</span>

<span class="n">handler</span>             <span class="o">=</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">settings</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"Failed to connect, as expected"</span><span class="p">;</span> <span class="no">EM</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">:port</span>     <span class="o">=&gt;</span> <span class="mi">5672</span><span class="p">,</span>
  <span class="ss">:vhost</span>    <span class="o">=&gt;</span> <span class="s2">"/amq_client_testbed"</span><span class="p">,</span>
  <span class="ss">:user</span>     <span class="o">=&gt;</span> <span class="s2">"amq_client_gem"</span><span class="p">,</span>
  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">"amq_client_gem_password_that_is_incorrect </span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">to_i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
  <span class="ss">:timeout</span>        <span class="o">=&gt;</span> <span class="mf">0.3</span><span class="p">,</span>
  <span class="ss">:on_tcp_connection_failure</span> <span class="o">=&gt;</span> <span class="n">handler</span><span class="p">,</span>
  <span class="ss">:on_possible_authentication_failure</span> <span class="o">=&gt;</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">settings</span><span class="o">|</span>
                                            <span class="nb">puts</span> <span class="s2">"Authentication failed, as expected, settings are: </span><span class="si">#{</span><span class="n">settings</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>

                                            <span class="no">EM</span><span class="p">.</span><span class="nf">stop</span>
                                          <span class="p">}</span>
<span class="p">}</span>

<span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">connection_settings</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="p">,</span> <span class="n">open_ok</span><span class="o">|</span>
  <span class="k">raise</span> <span class="s2">"This should not be reachable"</span>
<span class="k">end</span><span class="p">\</span><span class="o">&lt;</span><span class="sr">/pre&gt;

default handler raises `AMQP::PossibleAuthenticationFailureError`:
</span></code></pre></div><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"amqp"</span>

<span class="nb">puts</span> <span class="s2">"=&gt; Authentication failure handling with a rescue block"</span>
<span class="nb">puts</span>

<span class="n">handler</span>             <span class="o">=</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">settings</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"Failed to connect, as expected"</span><span class="p">;</span> <span class="no">EM</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">:port</span>     <span class="o">=&gt;</span> <span class="mi">5672</span><span class="p">,</span>
  <span class="ss">:vhost</span>    <span class="o">=&gt;</span> <span class="s2">"/amq_client_testbed"</span><span class="p">,</span>
  <span class="ss">:user</span>     <span class="o">=&gt;</span> <span class="s2">"amq_client_gem"</span><span class="p">,</span>
  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">"amq_client_gem_password_that_is_incorrect </span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">to_i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
  <span class="ss">:timeout</span>        <span class="o">=&gt;</span> <span class="mf">0.3</span><span class="p">,</span>
  <span class="ss">:on_tcp_connection_failure</span> <span class="o">=&gt;</span> <span class="n">handler</span>
<span class="p">}</span>


<span class="k">begin</span>
  <span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">connection_settings</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="p">,</span> <span class="n">open_ok</span><span class="o">|</span>
    <span class="k">raise</span> <span class="s2">"This should not be reachable"</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">PossibleAuthenticationFailureError</span> <span class="o">=&gt;</span> <span class="n">afe</span>
  <span class="nb">puts</span> <span class="s2">"Authentication failed, as expected, caught </span><span class="si">#{</span><span class="n">afe</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>
  <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="k">if</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">reactor_running?</span>
<span class="k">end</span>
</code></pre></div>
<p>In case you are wondering why the callback name has &quot;possible&quot; in it,
<a href="https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf">AMQP 0.9.1
spec</a> requires
broker implementations to simply close the TCP connection without
sending any more data when an exception, such as authentication
failure, occurs before the AMQP connection is open. In practice,
however, when a broker closes a TCP connection after a successful TCP
connection has been established but before an AMQP connection is open,
it means that authentication has failed.</p>

<h2 id="starting-the-event-loop-and-connecting-in-web-applications-ruby-on-rails-sinatra-merb-rack">Starting the event loop and connecting in Web applications (Ruby on Rails, Sinatra, Merb, Rack)</h2>

<p>Web applications are different from standalone applications in that
the main thread is occupied by a Web/application server like Unicorn
or Thin, so you need to start the EventMachine reactor before you
attempt to use <code>AMQP.connect</code>. In a Ruby on Rails
application, probably the best place for this is in the initializer
(like <code>config/initializers/amqp.rb</code>). For Merb applications it is <span
class="note">config/init.rb</span>. For Sinatra and pure Rack
applications, place it next to the other configuration code.</p>

<p>Next, we are going to discuss issues specific to particular Web servers.</p>

<h3 id="using-ruby-amqp-gem-with-unicorn">Using Ruby amqp gem with Unicorn</h3>

<h4 id="unicorn-is-a-pre-forking-server">Unicorn is a pre-forking server</h4>

<p><a href="http://unicorn.bogomips.org">Unicorn</a> is a pre-forking server. That
means it forks worker processes that serve HTTP requests. The
&quot;<a href="http://en.wikipedia.org/wiki/Fork_(operating_system)">ork(2)</a> system
call has several gotchas associated with it, two of which affect
EventMachine and the <a href="http://github.com/ruby-amqp/amqp">Ruby amqp
gem</a>:</p>

<ul>
<li>Unintentional file descriptor sharing</li>
<li>The fact that a <a href="http://bit.ly/fork-and-threads">forked child process only inherits one thread</a> and therefore the EventMachine thread is not inherited</li>
</ul>

<p>To avoid both problems, start the EventMachine reactor and AMQP
connection <em>after</em> the master process forks workers. The master
Unicorn process never serves HTTP requests and usually does not need
to hold an AMQP connection. Next, let us see how to spin up the
EventMachine reactor and connect to the broker after Unicorn forks a
worker.</p>

<h4 id="starting-the-eventmachine-reactor-and-connecting-to-the-broker-after-unicorn-forks-worker-processes">Starting the EventMachine reactor and connecting to the broker after Unicorn forks worker processes</h4>

<p>Unicorn lets you specify a configuration file to use. In that file you define a callback that Unicorn runs after it forks worker process(es):</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">ENV</span><span class="p">[</span><span class="s2">"FORKING"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"true"</span>

<span class="n">listen</span> <span class="mi">3000</span>

<span class="n">worker_processes</span> <span class="mi">1</span>
<span class="n">timeout</span>          <span class="mi">30</span>

<span class="n">preload_app</span> <span class="kp">true</span>


<span class="n">after_fork</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
  <span class="nb">require</span> <span class="s2">"amqp"</span>

  <span class="c1"># the following is *required* for Rails + "preload_app true",</span>
  <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span> <span class="n">and</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">establish_connection</span>


  <span class="n">t</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span> <span class="p">}</span>
  <span class="nb">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

  <span class="no">EventMachine</span><span class="p">.</span><span class="nf">next_tick</span> <span class="k">do</span>
    <span class="no">AMQP</span><span class="p">.</span><span class="nf">channel</span> <span class="o">||=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">AMQP</span><span class="p">.</span><span class="nf">connection</span><span class="p">)</span>
    <span class="no">AMQP</span><span class="p">.</span><span class="nf">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"amqpgem.examples.rails23.warmup"</span><span class="p">,</span> <span class="ss">:durable</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>

    <span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">"[after_fork/amqp] Publishing a warmup message #</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>

      <span class="no">AMQP</span><span class="p">.</span><span class="nf">channel</span><span class="p">.</span><span class="nf">default_exchange</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="s2">"A warmup message </span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2"> from </span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="err">'</span><span class="no">H</span><span class="ss">:M:S</span>
<span class="n">m</span><span class="o">/</span><span class="n">b</span><span class="o">/%</span><span class="no">Y</span><span class="err">’</span><span class="p">)</span><span class="si">}</span><span class="s2">“, :routing_key =&gt; ”amqpgem.examples.rails23.warmup“)
 end
 end
end
</span></code></pre></div>
<p>In the example above we start the EventMachine reactor in a separate
thread, block the current thread for 1 second to let the event loop spin
up and then connect to the AMQP broker on the next event loop tick.
Publishing several warmup messages on boot is a good idea because it
allows the early detection of issues that forking may cause.</p>

<p>Note that a configuration file can easily be used in development
environments because, other than the fact that Unicorn runs in the
foreground, it gives you exactly the same application boot behavior as
in QA and production environments.</p>

<p>An <a href="http://bit.ly/ruby-amqp-gem-example-with-ruby-on-rails-and-unicorn">example Ruby on Rails application that uses the Ruby amqp gem and
Unicorn</a>
is available on GitHub.</p>

<h3 id="using-the-ruby-amqp-gem-with-passenger">Using the Ruby amqp gem with Passenger</h3>

<p><a href="http://www.modrails.com">Phusion Passenger</a> is also a pre-forking
server, and just as with Unicorn, the EventMachine reactor and AMQP
connection should be started <strong>after</strong> it forks worker processes. The
Passenger documentation has <a href="http://bit.ly/passenger-forking-gotchas">a
section</a> that explains how to
avoid problems related to the behavior of the fork(2) system call,
namely:</p>

<ul>
<li>Unintentional file descriptor sharing</li>
<li>The fact that a <a href="http://bit.ly/fork-and-threads">forked child process only inherits one thread</a> and therefore the EventMachine thread is not inherited</li>
</ul>

<h4 id="using-an-event-handler-to-spawn-one-amqp-connection-per-worker">Using an event handler to spawn one amqp connection per worker</h4>

<p>Passenger provides a hook that you should use for spawning AMQP
connections:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">PhusionPassenger</span><span class="p">)</span> <span class="c1"># otherwise it breaks rake commands if you put this in an initializer</span>
  <span class="no">PhusionPassenger</span><span class="p">.</span><span class="nf">on_event</span><span class="p">(</span><span class="ss">:starting_worker_process</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">forked</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">forked</span>
       <span class="c1"># We’re in a smart spawning mode</span>
       <span class="c1"># Now is a good time to connect to the broker</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Basically, the recommended default smart spawn mode works exactly the
same as in Unicorn (with all of the same common pitfalls). An <a href="http://bit.ly/ruby-amqp-gem-example-with-ruby-on-rails-and-passenger">example
application</a>
is available on github.</p>

<h3 id="using-the-ruby-amqp-gem-with-thin-and-goliath">Using the Ruby amqp gem with Thin and Goliath</h3>

<h4 id="thin-and-goliath-start-the-eventmachine-reactor-for-you-but-there">Thin and Goliath start the EventMachine reactor for you, but there</h4>

<p>is a little nuance.</p>

<p>If you use <a href="http://code.macournoyer.com/thin/">Thin</a>
or <a href="https://github.com/postrank-labs/goliath/">Goliath</a>, you are all set
because those two servers use EventMachine under the hood. There is no
need to start the EventMachine reactor. However, depending on the
application server, its version, the version of the framework and Rack
middleware being used, EventMachine reactor start may be slightly
delayed. To overcome this potential difficulty, use
<code>EventMachine.next_tick</code> to delay connection until after the reactor is
actually running:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">EventMachine</span><span class="p">.</span><span class="nf">next_tick</span> <span class="p">{</span> <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="err">…</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div>
<p>So, in case the EventMachine reactor is not yet running on
server/application boot, the connection will not fail but will instead
wait for the reactor to start. Thin and Goliath are not pre-forking
servers so there is no need to re-establish the connection as you do
with Unicorn and Passenger.</p>

<h2 id="if-it-just-does-not-work-troubleshooting">If it just does not work: troubleshooting</h2>

<p>If you have read this guide and your issue is still unresolved, check
our <a href="/articles/troubleshooting/">Troubleshooting guide</a> before asking on
the mailing list.</p>

<h2 id="what-to-read-next">What to read next</h2>

<ul>
<li><a href="/articles/working_with_queues/">Working With Queues</a>. This guide
focuses on features that consumer applications use heavily.\</li>
<li><a href="/articles/working_with_exchanges/">Working With Exchanges</a>. This
guide focuses on features that producer applications use heavily.</li>
<li><a href="/articles/error_handling/">rror Handling &amp; Recovery</a>. This guide
explains how to handle protocol errors, network failures and other
things that may go wrong in real world projects.</li>
<li><a href="/articles/connection_encryption_with_tls/">Using TLS (SSL)</a> (if
you want to use an SSL encrypted connection to the broker)</li>
</ul>

        </div>
      </div>
    <footer class='footer'>
      <div class='container'>
        <p>This website was developed by the
          &nbsp;<a href='http://github.com/ruby-amqp'>Ruby RabbitMQ Client Maintainers Team</a>.</p>
        <p>Follow us on Twitter:
          &nbsp;<a href='http://twitter.com/rubyamqp'>rubyamqp</a>,&nbsp;<a href='http://twitter.com/michaelklishin'>Michael Klishin</a>,&nbsp;<a href='http://twitter.com/celldee'>Chris Duncan</a></p>
      </div>
    </footer>
  </body>
</html>
