<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en'>
  <head>
    <title>Durability and related matters</title>
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <meta content='A dead easy to use RabbitMQ Ruby client' name='description' />
    <meta content='The Ruby RabbitMQ Client Maintainers Team' name='author' />
    <link href='/assets/stylesheets/bootstrap.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/bootstrap-responsive.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/sass/styles.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='http://fonts.googleapis.com/css?family=Signika+Negative:300,400,600' rel='stylesheet' type='text/css' />
    <script src='/assets/javascripts/jquery-1.7.min.js' type='text/javascript'></script>
    <script src='/assets/javascripts/toc.js'></script>
    <script src='/assets/javascripts/bootstrap-collapse.js'></script>
    <meta content='text/html;charset=utf-8' http-equiv='Content-Type' />
    <script type="text/javascript">
      if(!(window.location.hostname === "localhost")) {
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-27153041-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
      }
    </script>
  </head>

  <body>
    <div class='navbar navbar-inverse navbar-fixed-top'>
      <div class='navbar-inner'>
        <div class='container-fluid'>
          <a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </a>
          <a class='brand' href='/'>Ruby amqp gem</a>
          <div class='nav-collapse'>
            <ul class='nav'>
            <li>
              <a href="/">Home</a>
            </li>
            <li>
              <a href="/articles/guides.html">All guides</a>
            </li>
            <li>
              <a href='/articles/community.html'>Community</a>
            </li>
            <li>
              <a href='http://rubybunny.info'>Bunny, an alternative client</a>
            </li>
            <li>
              <a href='https://github.com/ruby-amqp/amqp'>Code on Github</a>
            </li>
            <li>
              <a href='http://github.com/ruby-amqp'>Other RabbitMQ Ruby clients</a>
            </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class='container-fluid'>
      <div class='row-fluid'>
        <div class='span3'>
          <div class='well sidebar-nav'></div>
        </div>
        <div class='span9'>
          <h1>Durability and related matters</h1>
          <h2 id="about-this-guide">About this guide</h2>

<p>This guide covers queue, exchange and message durability, as well as
othertopics related to durability, for example, durability in cluster
environment.</p>

<p>This work is licensed under a
<a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative
Commons Attribution 3.0 Unported License</a> (including images and
stylesheets). The source is available <a href="https://github.com/ruby-amqp/rubyamqp.info">on
Github</a>.</p>

<h2 id="covered-versions">Covered versions</h2>

<p>This guide covers Ruby amqp gem 1.7.0 and later versions.</p>

<h2 id="entity-durability-and-message-persistence">Entity durability and message persistence</h2>

<h3 id="durability-of-exchanges">Durability of exchanges</h3>

<p>AMQP separates the concept of entity durability (queues, exchanges) from
message persistence. Exchanges can be durable or transient. Durable
exchanges survive broker restart, transient exchanges do not (they have
to be redeclared when broker comes back online). Not all scenarios and
use cases mandate exchanges to be durable.</p>

<h3 id="durability-of-queues">Durability of queues</h3>

<p>Durable queues are persisted to disk and thus survive broker restarts.
Queues that are not durable are called transient. Not all scenarios and
use cases mandate queues to be durable.</p>

<p>Note that <strong>only durable queues can be bound to durable exchanges</strong>.
This guarantees that it is possible to restore bindings on broker
restart.</p>

<p>Durability of a queue does not make <em>messages</em> that are routed to that
queue durable. If a broker is taken down and then brought back up,
durable queues will be re-declared during broker startup, however, only
<em>persistent</em> messages will be recovered.</p>

<h3 id="message-persistence">Message persistence</h3>

<p>Messages may be published as persistent and this is what makes an AMQP
broker persist them to disk. If the server is restarted, the system
ensures that received persistent messages are not lost. Simply
publishing a message to a durable exchange or the fact that a queue to
which a message is routed is durable does not make that message
persistent. It all depends on the persistence mode of the message
itself. Publishing messages as persistent affects performance (just like
with data stores, durability comes at a certain cost to performance and
vice versa). Pass :persistent =&gt; true to
{ yard_link AMQP::Exchange#publish } to publish your message as
persistent.</p>

<h3 id="transactions">Transactions</h3>

<p>TBD</p>

<h3 id="publisher-confirms">Publisher confirms</h3>

<p>Because transactions carry certain (for some applications, significant)
overhead, RabbitMQ introduced an extension to AMQP 0.9.1 called
<a href="http://www.rabbitmq.com/blog/2011/02/10/introducing-publisher-confirms/">publisher
confirms</a>
(<a href="http://www.rabbitmq.com/extensions.html#confirms">documentation</a>).</p>

<p>The amqp gem implements support for this extension, but it is not loaded
by default when you require “amqp”. To load it, use</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"amqp/extensions/rabbitmq"</span>
</code></pre></div>
<p>and then define a callback for publisher confirms using
<code>AMQP::Channel#confirm</code>:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># enable publisher acknowledgements for this channel</span>
<span class="n">channel</span><span class="p">.</span><span class="nf">confirm_select</span>

<span class="c1"># define a callback that will be executed when message is acknowledged</span>
<span class="n">channel</span><span class="p">.</span><span class="nf">on_ack</span> <span class="k">do</span> <span class="o">|</span><span class="n">basic_ack</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"Received an acknowledgement: delivery_tag = </span><span class="si">#{</span><span class="n">basic_ack</span><span class="p">.</span><span class="nf">delivery_tag</span><span class="si">}</span><span class="s2">, multiple = </span><span class="si">#{</span><span class="n">basic_ack</span><span class="p">.</span><span class="nf">multiple</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="c1"># define a callback that will be executed when message is rejected using basic.nack (a RabbitMQ-specific extension)</span>
<span class="n">channel</span><span class="p">.</span><span class="nf">on_nack</span> <span class="k">do</span> <span class="o">|</span><span class="n">basic_nack</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"Received a nack: delivery_tag = </span><span class="si">#{</span><span class="n">basic_nack</span><span class="p">.</span><span class="nf">delivery_tag</span><span class="si">}</span><span class="s2">, multiple = </span><span class="si">#{</span><span class="n">basic_nack</span><span class="p">.</span><span class="nf">multiple</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div>
<p>Note that the same callback is used for all messages published via all
exchanges on the given channel.</p>

<h3 id="clustering-and-high-availability">Clustering and High Availability</h3>

<p>To achieve the degree of durability that critical applications need,
it is necessary but not enough to use durable queues, exchanges and
persistent messages. You need to use a cluster of brokers because
otherwise, a single hardware problem may bring a broker down
completely.</p>

<p>RabbitMQ offers a number of high availability features for both
scenarios with more
(LAN) and less (WAN) reliable network connections.</p>

<p>See the <a href="http://www.rabbitmq.com/clustering.html">RabbitMQ clustering</a>
and <a href="http://www.rabbitmq.com/ha.html">high availability</a> guides for
in-depth discussion of this topic.</p>

<h3 id="highly-available-mirrored-queues">Highly Available (Mirrored) Queues</h3>

<p>Whilst the use of clustering provides for greater durability of
critical systems, in order to achieve the highest level of resilience
for queues and messages, high availability configuration should be
used. This is because although exchanges and bindings survive the loss
of individual nodes by using clustering, messages do
not. Without mirroring, queue contents reside on exactly one node, thus
the loss of a node will cause message loss.</p>

<p>See the <a href="http://www.rabbitmq.com/ha.html">RabbitMQ high availability\
guide</a> for more information about
mirrored queues.</p>

        </div>
      </div>
    <footer class='footer'>
      <div class='container'>
        <p>This website was developed by the
          &nbsp;<a href='http://github.com/ruby-amqp'>Ruby RabbitMQ Client Maintainers Team</a>.</p>
        <p>Follow us on Twitter:
          &nbsp;<a href='http://twitter.com/rubyamqp'>rubyamqp</a>,&nbsp;<a href='http://twitter.com/michaelklishin'>Michael Klishin</a>,&nbsp;<a href='http://twitter.com/celldee'>Chris Duncan</a></p>
      </div>
    </footer>
  </body>
</html>
