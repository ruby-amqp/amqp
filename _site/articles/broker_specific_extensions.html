<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en'>
  <head>
    <title>RabbitMQ Extensions to AMQP 0.9.1 in amqp gem</title>
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <meta content='A dead easy to use RabbitMQ Ruby client' name='description' />
    <meta content='The Ruby RabbitMQ Client Maintainers Team' name='author' />
    <link href='/assets/stylesheets/bootstrap.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/bootstrap-responsive.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/sass/styles.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='http://fonts.googleapis.com/css?family=Signika+Negative:300,400,600' rel='stylesheet' type='text/css' />
    <script src='/assets/javascripts/jquery-1.7.min.js' type='text/javascript'></script>
    <script src='/assets/javascripts/toc.js'></script>
    <script src='/assets/javascripts/bootstrap-collapse.js'></script>
    <meta content='text/html;charset=utf-8' http-equiv='Content-Type' />
    <script type="text/javascript">
      if(!(window.location.hostname === "localhost")) {
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-27153041-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
      }
    </script>
  </head>

  <body>
    <div class='navbar navbar-inverse navbar-fixed-top'>
      <div class='navbar-inner'>
        <div class='container-fluid'>
          <a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </a>
          <a class='brand' href='/'>Ruby amqp gem</a>
          <div class='nav-collapse'>
            <ul class='nav'>
            <li>
              <a href="/">Home</a>
            </li>
            <li>
              <a href="/articles/guides.html">All guides</a>
            </li>
            <li>
              <a href='/articles/community.html'>Community</a>
            </li>
            <li>
              <a href='http://rubybunny.info'>Bunny, an alternative client</a>
            </li>
            <li>
              <a href='https://github.com/ruby-amqp/amqp'>Code on Github</a>
            </li>
            <li>
              <a href='http://github.com/ruby-amqp'>Other RabbitMQ Ruby clients</a>
            </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class='container-fluid'>
      <div class='row-fluid'>
        <div class='span3'>
          <div class='well sidebar-nav'></div>
        </div>
        <div class='span9'>
          <h1>RabbitMQ Extensions to AMQP 0.9.1 in amqp gem</h1>
          <h2 id="rabbitmq-extensions">RabbitMQ extensions</h2>

<p>amqp gem supports many RabbitMQ extensions to AMQP 0.9.1:</p>

<ul>
<li><a href="http://www.rabbitmq.com/confirms.html">Publisher confirms</a></li>
<li><a href="http://www.rabbitmq.com/nack.html">Negative acknowledgements</a> (basic.nack)</li>
<li><a href="http://www.rabbitmq.com/e2e.html">Exchange-to-Exchange Bindings</a></li>
<li><a href="http://www.rabbitmq.com/ae.html">Alternate Exchanges</a></li>
<li><a href="http://www.rabbitmq.com/ttl.html#per-queue-message-ttl">Per-queue Message Time-to-Live</a></li>
<li><a href="http://www.rabbitmq.com/ttl.html#per-message-ttl">Per-message Time-to-Live</a></li>
<li><a href="http://www.rabbitmq.com/ttl.html#queue-ttl">Queue Leases</a></li>
<li><a href="http://www.rabbitmq.com/consumer-cancel.html">Consumer Cancellation Notifications</a></li>
<li><a href="http://www.rabbitmq.com/sender-selected.html">Sender-selected Distribution</a></li>
<li><a href="http://www.rabbitmq.com/dlx.html">Dead Letter Exchanges</a></li>
<li><a href="http://www.rabbitmq.com/validated-user-id.html">Validated user_id</a></li>
</ul>

<h2 id="enabling-rabbitmq-extensions">Enabling RabbitMQ extensions</h2>

<p>If you are using RabbitMQ and want to use these
extensions, simply replace</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"amqp"</span>
</code></pre></div>
<p>with</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"amqp"</span>
<span class="nb">require</span> <span class="s2">"amqp/extensions/rabbitmq"</span>
</code></pre></div>
<h2 id="per-queue-message-time-to-live">Per-queue Message Time-to-Live</h2>

<p>Per-queue Message Time-to-Live (TTL) is a RabbitMQ extension to AMQP
0.9.1 that allows developers to control how long a message published to
a queue can live before it is discarded. A message that has been in the
queue for longer than the configured TTL is said to be dead. Dead
messages will not be delivered to consumers and cannot be fetched using
the <strong>basic.get</strong> operation (<code>AMQP::Queue#pop</code>).</p>

<p>Message TTL is specified using the <strong>x-message-ttl</strong> argument on
declaration. With the amqp gem, you pass it to
<code>AMQP::Queue#initialize</code>
or<code>AMQP::Channel#queue</code>:</p>
<div class="highlight"><pre><code class="language-" data-lang="">&lt;code&gt;# 1000 millisecondschannel.queue("", :arguments =&gt; { "x-message-ttl" =&gt; 1000 })&lt;/code&gt;
</code></pre></div>
<p>When a published message is routed to multiple queues, each of the
queues gets a <em>copy of the message</em>. If the message subsequently dies in
one of the queues, it has no effect on copies of the message in other
queues.</p>

<h3 id="example">Example</h3>

<p>The example below sets the message TTL for a new server-named queue to
be 1000 milliseconds. It then publishes several messages that are routed
to the queue and tries to fetch messages using the <strong>basic.get</strong> AMQP
method (<code>AMQP::Queue#pop</code> after 0.7 and 1.5 seconds:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'amqp'</span>
<span class="nb">require</span> <span class="s2">"amqp/extensions/rabbitmq"</span>

<span class="no">AMQP</span><span class="p">.</span><span class="nf">start</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"Connected!"</span>
  <span class="n">channel</span> <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">channel</span><span class="p">.</span><span class="nf">on_error</span> <span class="k">do</span> <span class="o">|</span><span class="n">ch</span><span class="p">,</span> <span class="n">channel_close</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"Oops! a channel-level exception: </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_text</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"amq.fanout"</span><span class="p">)</span>
  <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:arguments</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"x-message-ttl"</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"Declared a new server-named queue: </span><span class="si">#{</span><span class="n">q</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">q</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span> <span class="k">do</span>
      <span class="mi">10</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="nb">puts</span> <span class="s2">"Publishing message #</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">x</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="s2">"Message #</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">q</span><span class="p">.</span><span class="nf">pop</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
        <span class="nb">puts</span> <span class="s2">"Got a message: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">q</span><span class="p">.</span><span class="nf">pop</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">payload</span><span class="p">.</span><span class="nf">nil?</span>
          <span class="nb">puts</span> <span class="s2">"No messages in the queue"</span>
        <span class="k">else</span>
          <span class="k">raise</span> <span class="s2">"x-message-ttl didn't seem to work (timeout isn't up)"</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">show_stopper</span> <span class="o">=</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span>
    <span class="no">AMQP</span><span class="p">.</span><span class="nf">stop</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
  <span class="p">}</span>


  <span class="no">EM</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">show_stopper</span><span class="p">)</span>
  <span class="no">Signal</span><span class="p">.</span><span class="nf">trap</span><span class="p">(</span><span class="s1">'INT'</span><span class="p">,</span>  <span class="n">show_stopper</span><span class="p">)</span>
  <span class="no">Signal</span><span class="p">.</span><span class="nf">trap</span><span class="p">(</span><span class="s1">'TERM'</span><span class="p">,</span> <span class="n">show_stopper</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="learn-more">Learn More</h3>

<p>See also rabbitmq.com section on <a href="http://www.rabbitmq.com/ttl.html#per-queue-message-ttl">Per-queue Message
TTL</a></p>

<h2 id="publisher-confirms-publisher-acknowledgements">Publisher Confirms (Publisher Acknowledgements)</h2>

<p>In some situations it is essential that no messages are lost. The only
reliable way of ensuring this is by using confirmations. The <a href="http://www.rabbitmq.com/blog/2011/02/10/introducing-publisher-confirms/">Publisher
Confirms AMQP
extension</a>
was designed to solve the reliable publishing problem.</p>

<p>Publisher confirms are similar to message acknowledgements documented in
the <a href="/articles/working_with_queues/">Working With Queues</a> guide but
involve a publisher and the AMQP broker instead of a consumer and the
AMQP broker.</p>

<p><img src="https://github.com/ruby-amqp/amqp/raw/master/docs/diagrams/006_amqp_091_message_acknowledgements.png" alt=""></p>

<p><img src="https://github.com/ruby-amqp/amqp/raw/master/docs/diagrams/007_rabbitmq_publisher_confirms.png" alt=""></p>

<h3 id="public-api">Public API</h3>

<p>To use publisher confirmations, first put the channel into confirmation
mode using <code>AMQP::Channel#confirm_select</code>:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">channel</span><span class="p">.</span><span class="nf">confirm_select</span>
</code></pre></div>
<p>From this moment on, every message published on this channel will cause
the channel’s <em>publisher index</em> (message counter) to be incremented. It
is possible to access the index using
<code>AMQP::Channel#publisher_index</code> method. To check whether
the channel is in confirmation mode, use the
<code>AMQP::Channel#uses_publisher_confirmations?</code>
predicate.
To handle AMQP broker acknowledgements, define a handler using
<code>AMQP::Channel#on_ack</code>, for example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">channel</span><span class="p">.</span><span class="nf">on_ack</span> <span class="k">do</span> <span class="o">|</span><span class="n">basic_ack</span><span class="o">|</span>
 <span class="nb">puts</span> <span class="s2">"Received basic_ack: multiple = </span><span class="si">#{</span><span class="n">basic_ack</span><span class="p">.</span><span class="nf">multiple</span><span class="si">}</span><span class="s2">, delivery_tag = </span><span class="si">#{</span><span class="n">basic_ack</span><span class="p">.</span><span class="nf">delivery_tag</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div>
<p>The delivery tag will indicate the number of confirmed messages. If the
<strong>multiple</strong> attribute is true, the confirmation is for all messages up
to the number that the delivery tag indicates. In other words, an AMQP
broker may confirm just one message or a batch of them.</p>

<h3 id="example">Example</h3>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"bundler"</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">setup</span>

<span class="vg">$:</span><span class="p">.</span><span class="nf">unshift</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s2">"../../../../lib"</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">))</span>
<span class="nb">require</span> <span class="s1">'amqp'</span>
<span class="nb">require</span> <span class="s2">"amqp/extensions/rabbitmq"</span>

<span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="n">connection</span> <span class="o">=</span> <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">'127.0.0.1'</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Connecting to AMQP broker. Running </span><span class="si">#{</span><span class="no">AMQP</span><span class="o">::</span><span class="no">VERSION</span><span class="si">}</span><span class="s2"> version of the gem..."</span>

  <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">channel</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"Channel </span><span class="si">#{</span><span class="n">channel</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2"> is now open"</span>

    <span class="n">channel</span><span class="p">.</span><span class="nf">confirm_select</span>
    <span class="n">channel</span><span class="p">.</span><span class="nf">on_error</span> <span class="p">{</span> <span class="o">|</span><span class="n">ch</span><span class="p">,</span> <span class="n">channel_close</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"Oops! a channel-level exception: </span><span class="si">#{</span><span class="n">channel_close</span><span class="p">.</span><span class="nf">reply_text</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">channel</span><span class="p">.</span><span class="nf">on_ack</span>   <span class="p">{</span> <span class="o">|</span><span class="n">basic_ack</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"Received basic_ack: multiple = </span><span class="si">#{</span><span class="n">basic_ack</span><span class="p">.</span><span class="nf">multiple</span><span class="si">}</span><span class="s2">, delivery_tag = </span><span class="si">#{</span><span class="n">basic_ack</span><span class="p">.</span><span class="nf">delivery_tag</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"amq.fanout"</span><span class="p">)</span>
    <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span>
      <span class="n">q</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="nf">subscribe</span><span class="p">(</span><span class="ss">:ack</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">header</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
        <span class="nb">puts</span> <span class="s2">"Received </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="no">EventMachine</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">do</span>
      <span class="mi">10</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="nb">puts</span> <span class="s2">"Publishing message #</span><span class="si">#{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">x</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="s2">"Message #</span><span class="si">#{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">show_stopper</span> <span class="o">=</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span>
    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="no">EM</span><span class="p">.</span><span class="nf">add_timer</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">show_stopper</span><span class="p">)</span>
  <span class="no">Signal</span><span class="p">.</span><span class="nf">trap</span><span class="p">(</span><span class="s1">'INT'</span><span class="p">,</span>  <span class="n">show_stopper</span><span class="p">)</span>
  <span class="no">Signal</span><span class="p">.</span><span class="nf">trap</span><span class="p">(</span><span class="s1">'TERM'</span><span class="p">,</span> <span class="n">show_stopper</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="learn-more">Learn More</h3>

<p>See also rabbitmq.com section on <a href="http://www.rabbitmq.com/confirms.html">Confirms aka Publisher
Acknowledgements</a></p>

<h2 id="basic-nack">basic.nack</h2>

<p>The AMQP 0.9.1 specification defines the basic.reject method that allows
clients to reject individual, delivered messages, instructing the broker
to either discard them or requeue them. Unfortunately, basic.reject
provides no support for negatively acknowledging messages in bulk.</p>

<p>To solve this, RabbitMQ supports the basic.nack method that provides all
of the functionality of basic.reject whilst also allowing for bulk
processing of messages.</p>

<h3 id="public-api">Public API</h3>

<p>When RabbitMQ extensions are loaded, the
<code>AMQP::Channel#reject</code> method is overriden via a mixin to
take one additional argument: multi (defaults to false). When the
‘multi’ argument is passed with a value of ‘true’, then the amqp gem
will use the basic.nack AMQP method, instead of basic.reject, to reject
multiple messages at once. Otherwise, basic.reject is used as usual.</p>

<h3 id="learn-more">Learn More</h3>

<p>See also rabbitmq.com section on <a href="http://www.rabbitmq.com/nack.html">Confirms aka Publisher
Acknowledgements</a></p>

<h2 id="alternate-exchanges">Alternate Exchanges</h2>

<p>Alternate Exchanges is a RabbitMQ extension to AMQP 0.9.1 that allows
developers to define “fallback” exchanges where unroutable messages will
be sent.</p>

<h3 id="public-api">Public API</h3>

<p>To specify exchange A as an alternate exchange to exchange B, specify
the ‘alternate-exchange’ argument on declaration of B:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">exchange1</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"ops.fallback"</span><span class="p">,</span>     <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">exchange2</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"events.collector"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:arguments</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"alternate-exchange"</span> <span class="o">=&gt;</span> <span class="s2">"ops.fallback"</span> <span class="p">})</span>
</code></pre></div>
<h3 id="example">Example</h3>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">"bundler"</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">setup</span>

<span class="vg">$:</span><span class="p">.</span><span class="nf">unshift</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s2">"../../../../lib"</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">))</span>

<span class="nb">require</span> <span class="s1">'amqp'</span>

<span class="no">EventMachine</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="n">connection</span> <span class="o">=</span> <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">'127.0.0.1'</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Connecting to AMQP broker. Running </span><span class="si">#{</span><span class="no">AMQP</span><span class="o">::</span><span class="no">VERSION</span><span class="si">}</span><span class="s2"> version of the gem..."</span>

  <span class="n">channel</span>   <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">queue</span>     <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"amqpgem.examples.hello_world"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">exchange1</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"my.fanout1"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">exchange2</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"my.fanout2"</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:arguments</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"alternate-exchange"</span> <span class="o">=&gt;</span> <span class="s2">"my.fanout1"</span> <span class="p">})</span>

  <span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange1</span><span class="p">).</span><span class="nf">subscribe</span> <span class="k">do</span> <span class="o">|</span><span class="n">payload</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"Received a message: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">. Disconnecting..."</span>

    <span class="n">connection</span><span class="p">.</span><span class="nf">close</span> <span class="p">{</span> <span class="no">EventMachine</span><span class="p">.</span><span class="nf">stop</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">exchange1</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"This message will be routed because of the binding"</span><span class="p">,</span>   <span class="ss">:mandatory</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">exchange2</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"This message will be re-routed to alternate-exchange"</span><span class="p">,</span> <span class="ss">:mandatory</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="learn-more">Learn More</h3>

<p>See also rabbitmq.com section on <a href="http://www.rabbitmq.com/ae.html">Alternate
Exchanges</a></p>

<h2 id="wrapping-up">Wrapping Up</h2>

<p>With amqp gem you can use a number of RabbitMQ extensions to AMQP 0.9.1.
Some are special features in the library, while some other are used via
extra declaration attributes and message properties.</p>

        </div>
      </div>
    <footer class='footer'>
      <div class='container'>
        <p>This website was developed by the
          &nbsp;<a href='http://github.com/ruby-amqp'>Ruby RabbitMQ Client Maintainers Team</a>.</p>
        <p>Follow us on Twitter:
          &nbsp;<a href='http://twitter.com/rubyamqp'>rubyamqp</a>,&nbsp;<a href='http://twitter.com/michaelklishin'>Michael Klishin</a>,&nbsp;<a href='http://twitter.com/celldee'>Chris Duncan</a></p>
      </div>
    </footer>
  </body>
</html>
