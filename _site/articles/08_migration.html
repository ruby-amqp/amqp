<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en'>
  <head>
    <title>Upgrading to amqp gem 0.8.x and later versions</title>
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <meta content='A dead easy to use RabbitMQ Ruby client' name='description' />
    <meta content='The Ruby RabbitMQ Client Maintainers Team' name='author' />
    <link href='/assets/stylesheets/bootstrap.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/bootstrap-responsive.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/sass/styles.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='http://fonts.googleapis.com/css?family=Signika+Negative:300,400,600' rel='stylesheet' type='text/css' />
    <script src='/assets/javascripts/jquery-1.7.min.js' type='text/javascript'></script>
    <script src='/assets/javascripts/toc.js'></script>
    <script src='/assets/javascripts/bootstrap-collapse.js'></script>
    <meta content='text/html;charset=utf-8' http-equiv='Content-Type' />
    <script type="text/javascript">
      if(!(window.location.hostname === "localhost")) {
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-27153041-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
      }
    </script>
  </head>

  <body>
    <div class='navbar navbar-inverse navbar-fixed-top'>
      <div class='navbar-inner'>
        <div class='container-fluid'>
          <a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </a>
          <a class='brand' href='/'>Ruby amqp gem</a>
          <div class='nav-collapse'>
            <ul class='nav'>
            <li>
              <a href="/">Home</a>
            </li>
            <li>
              <a href="/articles/guides.html">All guides</a>
            </li>
            <li>
              <a href='/articles/community.html'>Community</a>
            </li>
            <li>
              <a href='http://rubybunny.info'>Bunny, an alternative client</a>
            </li>
            <li>
              <a href='https://github.com/ruby-amqp/amqp'>Code on Github</a>
            </li>
            <li>
              <a href='http://github.com/ruby-amqp'>Other RabbitMQ Ruby clients</a>
            </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class='container-fluid'>
      <div class='row-fluid'>
        <div class='span3'>
          <div class='well sidebar-nav'></div>
        </div>
        <div class='span9'>
          <h1>Upgrading to amqp gem 0.8.x and later versions</h1>
          <h2 id="about-this-guide">About this guide</h2>

<p>This guide explains how (and why) applications that use amqp gem
versions 0.6.x and 0.7.x should migrate to 0.8.0 and future versions. It
also outlines deprecated features and when and why they will be removed.</p>

<p>This work is licensed under a
<a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative
Commons Attribution 3.0 Unported License</a> (including images and
stylesheets). The source is available <a href="https://github.com/ruby-amqp/rubyamqp.info">on
Github</a>.</p>

<h2 id="covered-versions">Covered versions</h2>

<p>This guide covers Ruby amqp gem 0.6.x and 0.7.x.</p>

<h2 id="brief-history-of-amqp-gem">Brief history of amqp gem</h2>

<p>The amqp gem was born in early July 2008. Since then, it has seen 7
releases, used by all kinds of companies, and has become a key component
in systems that process more than 100 gigabytes of data per day. Also,
despite not being a “1.0 library”, it has proven to be very usable.</p>

<p>For most of 2008 and 2009 the gem did not receive much of attention. In
2010, some other AMQP clients (for example, RabbitMQ Java &amp; .NET
clients) switched to the AMQP 0.9.1 specification. By the fall of 2010
it had become clear that the amqp gem needed a new team of maintainers,
deep refactoring, new solid test suite and extensive documentation
guides. Long story short, by December 2010, the <a href="https://github.com/ruby-amqp">new maintainers
group</a> was formed and now maintains a
number of other libraries in the Ruby AMQP ecosystem, most notably the
<a href="github.com/ruby-amqp/bunny">Bunny gem</a>.</p>

<p>Over the first few months of 2011, the amqp gem underwent a number of
maintenance releases (known as the 0.7.x series), a ground up rewrite of
the test suite, major documentation update as well as a major
refactoring. It was upgraded to the AMQP 0.9.1 specification and based
on a new, much more efficient AMQP serialization library,
<a href="https://github.com/ruby-amqp/amq-protocol">amq-protocol</a>.</p>

<p>As part of this transition, the amqp gem maintainers team pursued a
number of goals:</p>

<ul>
<li>Implement the AMQP 0.9.1 spec plus all of the RabbitMQ extensions</li>
<li>End the &quot;300 of 1 patch forks&quot; situation that had become especially bad
in early 2010</li>
<li>Produce a solid end-to-end test suite that imitates real
asynchronous applications</li>
<li>Resolve many API usability issues: inconsistent behavior, weird
class and method naming, heavy reliance on implicit connection objects
and so on</li>
<li>Produce documentation guides that other AMQP client users will be
envious of</li>
<li>Define a stable public API</li>
<li>Improve memory efficiency and performance</li>
<li>Resolve many limitations of the original API and implementation
design</li>
<li>Drop all of the &quot;experimental-stuff-that-was-never-finished&quot;</li>
</ul>

<p>In the end, several projects like
<a href="https://github.com/ruby-amqp/evented-spec">evented-spec</a> were born and
became part of the amqp gem family of libraries. The &quot;300 one patch
forks&quot; hell is a thing of the past. Even the initial pure Ruby
implementation of the new serialization library was <a href="http://www.rabbitmq.com/blog/2011/03/01/ruby-amqp-benchmarks/">several times as
memory
efficient</a>
as the original one. The response to the <a href="http://bit.ly/amqp-gem-docs">Documentation
guides</a> response was very positive.
amqp gem 0.8.0 implemented all but one RabbitMQ extension as well as
AMQP 0.9.1 spec features that the original gem never fully implemented.
Many heavy users of the gem upgraded to 0.8 or later versions. The future for
the amqp gem and its spin-offs is bright.</p>

<h2 id="amqp-gem-0-8-0-backwards-compatibility-policy">amqp gem 0.8.0 backwards compatibility policy</h2>

<p>amqp gem 0.8.0 is *<em>not
100 backwards compatible</em>. That said, for most applications, the upgrade path is easy. Over 90
of the deprecated API classes and methods are still in place and will
only be dropped in the 0.9.0 release.</p>

<p>Plenty of the incompatibilities between the 0.6.x and 0.7.x series were
ironed out in 0.8.0. This guide will explain what has changed and
why. It will also encourage you to upgrade and show how you should adapt
your application code.</p>

<h2 id="why-developers-should-upgrade-to-0-8-0">Why developers should upgrade to 0.8.0</h2>

<ul>
<li><a href="http://rubyamqp.info">Great documentation</a></li>
<li>amqp gem 0.8.0 and later versions are actively maintained</li>
<li>Most of the heaviest library users have either already switched to
amqp gem 0.8.0 or are switching in the near future</li>
<li>AMQP 0.9.1 spec implementation: many other popular clients, for
example the RabbitMQ Java client, has dropped support for the AMQP 0.8
specification</li>
<li>Support for RabbitMQ extensions</li>
<li>Applications that do not use deprecated API features and behaviors
will have a seamless upgrade path to amqp gem 0.9.0 and beyond</li>
</ul>

<h2 id="amqp-protocol-version-change">AMQP protocol version change</h2>

<p>amqp gems before 0.8.0 (0.6.x, 0.7.x) series implemented (most of) the
AMQP 0.8 specification. amqp gem 0.8.0 implements AMQP 0.9.1 and thus
<strong>requires RabbitMQ version 2.0 or later</strong>. See <a href="/articles/rabbitmq_versions/">RabbitMQ
versions</a> for more information about
RabbitMQ versions support and how to obtain up-to-date packages for your
operating system.</p>

<p><span class="note">
amqp gem 0.8.0 and later versions implement AMQP 0.9.1 and thus
<strong>require RabbitMQ version 2.0 or later</strong>
</span></p>

<h2 id="follow-established-amqp-terminology">Follow established AMQP terminology</h2>

<h3 id="require-mq-is-deprecated">require “mq” is deprecated</h3>

<p>Instead of the following:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"amqp"</span>
<span class="nb">require</span> <span class="s2">"mq"</span>
</code></pre></div>
<p>or</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"mq"</span>
</code></pre></div>
<p>switch to</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"amqp"</span>
</code></pre></div>
<p><span class="note">
mq.rb will be removed before 1.0 release.
</span></p>

<h3 id="mq-class-is-deprecated">MQ class is deprecated</h3>

<p>Please use <code>AMQP::Channel</code> instead. MQ class and its
methods are implemented in amqp gem 0.8.x for backwards compatibility.</p>

<p>Why is it deprecated? Because it was a poor name choice. Both mq.rb and
the MQ class depart from AMQP terminology and make eight out of ten
engineers think that they have something to do with AMQP queues (in
fact, MQ should have been called Channel in the first place). No other
RabbitMQ client library that we know of invents its own terminology when it
comes to protocol entities and the amqp gem shouldn’t either.</p>

<p><span class="note">
The MQ class and class methods that use an implicit connection (MQ.queue
and so on) will be removed before the 1.0 release.
</span></p>

<h2 id="mq-class-is-now-amqp-channel">MQ class is now AMQP::Channel</h2>

<p>The MQ class was renamed to AMQP::Channel to follow the established
<a href="/articles/amqp_9_1_model_explained/">AMQP 0.9.1 terminology</a>. Implicit
per-thread channels are deprecated:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># amqp gem 0.6.x code style: connection is implicit, channel is implicit. Error handling and recovery are thus</span>
<span class="c1"># not possible.</span>
<span class="c1"># Deprecated, do not use.</span>
<span class="no">MQ</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"search.indexing"</span><span class="p">)</span>

<span class="c1"># same for exchanges. Deprecated, do not use.</span>
<span class="no">MQ</span><span class="p">.</span><span class="nf">direct</span><span class="p">(</span><span class="s2">"services.imaging"</span><span class="p">)</span>
<span class="no">MQ</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"services.broadcast"</span><span class="p">)</span>
<span class="no">MQ</span><span class="p">.</span><span class="nf">topic</span><span class="p">(</span><span class="s2">"services.weather_updates"</span><span class="p">)</span>

<span class="c1"># connection object lets you define error handlers</span>
<span class="n">connection</span> <span class="o">=</span> <span class="no">AMQP</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">:vhost</span> <span class="o">=&gt;</span> <span class="s2">"myapp/production"</span><span class="p">,</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"192.168.0.18"</span><span class="p">)</span>
<span class="c1"># channel object lets you define error handlers and use multiple channels per application,</span>
<span class="c1"># for example, one per thread</span>
<span class="n">channel</span>    <span class="o">=</span> <span class="no">AMQP</span><span class="o">::</span><span class="no">Channel</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
<span class="c1"># AMQP::Channel#queue remains unchanged otherwise</span>
<span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s2">"search.indexing"</span><span class="p">)</span>

<span class="c1"># exchanges examples</span>
<span class="n">channel</span><span class="p">.</span><span class="nf">direct</span><span class="p">(</span><span class="s2">"services.imaging"</span><span class="p">)</span>
<span class="n">channel</span><span class="p">.</span><span class="nf">fanout</span><span class="p">(</span><span class="s2">"services.broadcast"</span><span class="p">)</span>
<span class="n">channel</span><span class="p">.</span><span class="nf">topic</span><span class="p">(</span><span class="s2">"services.weather_updates"</span><span class="p">)</span>
</code></pre></div>
<p><span class="note">
MQ.queue, MQ.direct, MQ.fanout and MQ.topic methods will be removed
before 1.0 release. Use
instance methods on AMQP::Channel (AMQP::Channel#queue,
AMQP::Channel#direct, AMQP::Channel#default_exchange
and so on) instead.
</span></p>

<h2 id="mq-queue-is-now-amqp-queue">MQ::Queue is now AMQP::Queue</h2>

<p>MQ::Queue is now AMQP::Queue. All the methods from 0.6.x series are
still available.</p>

<p><span class="note">
MQ::Queue alias will be removed before 1.0 release. Please switch to
AMQP::Queue.
</span></p>

<h2 id="mq-exchange-is-now-amqp-exchange">MQ::Exchange is now AMQP::Exchange</h2>

<p>MQ::Exchange is now AMQP::Exchange. All of the methods from the 0.6.x
series are still available.</p>

<p><span class="note">
MQ::Exchange alias will be removed before 1.0 release. Please switch to
AMQP::Exchange.
</span></p>

<h2 id="mq-header-is-now-amqp-header">MQ::Header is now AMQP::Header</h2>

<p>MQ::Header is now AMQP::Header. If your code has any type checks or case
matches on MQ::Header, it needs to change to AMQP::Header.</p>

<h2 id="amqp-error-is-deprecated">AMQP.error is deprecated</h2>

<p>Catch-all solutions for error handling are very difficult to use.
Automatic recovery and fine-grained event handling is also not possible.
amqp gem 0.8.0 and later includes a fine-grained <a href="/articles/error_handling/">Error Handling
and Recovery API</a> that is significantly
easier to use in real-world cases but also makes automatic recovery mode
possible.</p>

<p><span class="note">
AMQP.error method will be removed before 1.0 release.
</span></p>

<h2 id="mq-rpc-is-deprecated">MQ::RPC is deprecated</h2>

<p>It was an experiment that was never finished. Some API design choices
are very opinionated as well. The amqp gem should not ship with
half-baked poorly designed or overly opinionated solutions.</p>

<p><span class="note">
MQ::RPC class will be removed before 1.0 release.
</span></p>

<h2 id="mq-logger-is-removed">MQ::Logger is removed</h2>

<p>It was another experiment that was never finished.</p>

<p><span class="note">
MQ::Logger class was removed in the the amqp gem 0.8.0 development
cycle.
</span></p>

<h2 id="amqp-buffer-is-removed">AMQP::Buffer is removed</h2>

<p>AMQP::Buffer was an AMQP 0.8 protocol implementation detail. With the
new <a href="http://rubygems.org/gems/amq-protocol">amq-protocol gem</a>, it is no
longer required.</p>

<p><span class="note">
AMQP::Buffer class was removed in the the amqp gem 0.8.0 development
cycle.
</span></p>

<h2 id="amqp-frame-is-removed">AMQP::Frame is removed</h2>

<p>AMQP::Frame was an AMQP 0.8 protocol implementation detail. With the new
<a href="http://rubygems.org/gems/amq-protocol">amq-protocol gem</a>, it is no
longer required.</p>

<p><span class="note">
AMQP::Frame class was removed in the the amqp gem 0.8.0 development
cycle.
</span></p>

<h2 id="amqp-server-is-removed">AMQP::Server is removed</h2>

<p>AMQP::Server was (an unfinished) toy implementation of AMQP 0.8 broker
in Ruby on top of EventMachine. We believe that Ruby is not an optimal
choice for AMQP broker implementations. We also never heard of anyone
using it.</p>

<p><span class="note">
AMQP::Server class was removed in the amqp gem 0.8.0 development cycle.
</span></p>

<h2 id="amqp-protocol-classes-are-removed">AMQP::Protocol::* classes are removed</h2>

<p>AMQP::Protocol::* classes were an AMQP 0.8 protocol implementation
detail. With the new <a href="http://rubygems.org/gems/amq-protocol">amq-protocol
gem</a>, they are no longer
required.</p>

<p><span class="note">
AMQP::Protocol::* classes were removed in the the amqp gem 0.8.0
development cycle.
</span></p>

        </div>
      </div>
    <footer class='footer'>
      <div class='container'>
        <p>This website was developed by the
          &nbsp;<a href='http://github.com/ruby-amqp'>Ruby RabbitMQ Client Maintainers Team</a>.</p>
        <p>Follow us on Twitter:
          &nbsp;<a href='http://twitter.com/rubyamqp'>rubyamqp</a>,&nbsp;<a href='http://twitter.com/michaelklishin'>Michael Klishin</a>,&nbsp;<a href='http://twitter.com/celldee'>Chris Duncan</a></p>
      </div>
    </footer>
  </body>
</html>
